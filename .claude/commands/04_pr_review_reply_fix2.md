# /04_pr_review_reply_fix2

## 使い方

```
/04_pr_review_reply_fix2 <PR番号>
```

PR レビューコメント修正コマンド

## 目的

あなたは Pull Request のレビューコメントを網羅的に確認しコードを修正する AI アシスタントです。
現在のブランチ紐づいている PR 情報を取得し詳細な計画を作り、コードを修正した上でコメントに返信しましょう。

## 重要な注意事項

- 必要に応じて WEB の情報を参照してください。なお参照する場合は 2025 年 7 月時点最新の情報を参照しましょう
- 現在のブランチに PR が紐づいてない場合はここで作業を終了してください

---

## Pull Request 修正手順

### Phase 1: コメント情報の収集

1. `gh pr view --comments` で PR の詳細とコメントを取得
2. `gh api repos/{ORGANIZATION}/{CURRENT_REPO}/pulls/{PR_NUMBER}/comments` で詳細なコメントデータを取得
3. `gh api repos/{ORGANIZATION}/{CURRENT_REPO}/pulls/{PR_NUMBER}/reviews` でレビューコメントを取得
4. 必要に応じて `gh api repos/{ORGANIZATION}/{CURRENT_REPO}/issues/{PR_NUMBER}/comments` で一般コメントも確認

### Phase 2: コメント分析と分類

収集したコメントを以下の観点で分析してください：

1. **コメントの分類**

   - 🔴 必須修正項目（blocking issues）
   - 🟡 推奨修正項目（suggestions）
   - 🟢 質問・議論項目（questions/discussions）

2. **技術的重要度**

   - 🚨 クリティカル（システム障害リスク）
   - 🔥 高（本番環境への影響大）
   - 📈 中（品質・保守性への影響）
   - 📝 低（スタイル・可読性）
   - 🎯 改善提案（将来的な拡張性）

3. **カテゴリー**

   - **仕様適合性に関する指摘**
     - 既存機能の仕様
     - 受け入れ条件
   - **コーディングルールに関する指摘**
     - 命名規則の統一性
     - インデント・フォーマット
   - **パフォーマンスに関する指摘**
     - メモリ使用量の最適化
     - データベースクエリの効率性
     - API 呼び出しの最適化
     - キャッシュ戦略
   - **アーキテクチャに関する指摘**
     - 類似実装との統一性
     - 過去意思決定(ADR)との整合性
     - 依存関係の方向性
     - デザインパターンの適用
   - **テスト品質に関する指摘**
     - テストカバレッジの妥当性
     - テストケースの網羅性
     - モックの適切性
     - テストの可読性・保守性
   - **エラーハンドリングに関する指摘**
     - 例外処理の適切性
     - エラーメッセージの明確性
     - ログ出力の妥当性
     - 復旧可能性の考慮
   - **可読性・保守性に関する指摘**
     - コードの自己文書化
     - コメントの適切性
     - 関数・クラスの責務分離
     - 複雑度の管理

4. **影響範囲**
   - 単一ファイル修正
   - 複数ファイル修正
   - アーキテクチャ変更
   - 依存関係変更
   - データベーススキーマ変更
   - API 仕様変更

### Phase 3: 修正計画の立案

**重要**

- 分析結果について深く考え(ULTRATHINK)、修正計画を作成してください
- 分類されたコメントのうち修正するのは`必須修正項目`と`推奨修正項目`の 2 つのみでお願いします。

`````markdown
# PR #{PR_NUMBER} 修正計画

## 📋 コメント一覧

| コメントの分類 | カテゴリー   | ファイル       | 内容                     | レビュアー |
| -------------- | ------------ | -------------- | ------------------------ | ---------- |
| 🔴             | Code Quality | src/main.js:15 | 変数名をより具体的に     | @reviewer1 |
| 🟡             | Performance  | src/api.js:42  | キャッシュ機能の追加検討 | @reviewer2 |

## 🎯 修正方針

### 必須修正項目（Phase 1）

- [ ] 項目 1: 詳細な修正内容
- [ ] 項目 2: 詳細な修正内容

### 推奨修正項目（Phase 2）

- [ ] 項目 1: 詳細な修正内容
- [ ] 項目 2: 詳細な修正内容

## 📅 実装順序

1. 必須修正項目の実装
2. 推奨修正項目の実装
3. テスト実行・検証
4. プッシュ・レビュー依頼

## ⚠️ 注意事項

- 質問・議論項目に分類されたものは計画不要です
- 修正により既存機能に影響がないか確認
- テストが全て通ることを確認
- 依存関係の変更がある場合は慎重に検討
  `​``

### Phase 4: 計画品質のチェック

- [ ] PR 上の全コメントを参照している
- [ ] 全コメントが「必須修正項目」「推奨修正項目」「質問・議論項目」の 3 つに分類されている
- [ ] コメントの内容が分析されている
- [ ] 具体的で明確な修正方針が作成されている

計画の 80%がチェックされている状態になるまで次のフェーズに進まないでください。

### Phase 5: ユーザー確認

`修正計画`を提示し、以下を確認してください：

- 修正方針に問題がないか
- 優先順位が適切か
- 追加で考慮すべき点がないか

**この段階で必ずユーザーの承認を得てから次の Phase に進んでください。**

### Phase 6: 実装実行

ユーザーの承認後、以下の手順で実装を行ってください：

#### 1. 事前準備

- 現在のブランチの状態確認
- 依存関係の確認
- 計画の確認

#### 2. 修正実装

- 優先度順に修正を実施
- 各修正後にコミットを作成
- コミットメッセージには PR 番号と修正内容を記載

#### 3. 検証

- [ ] フォーマットチェック(必要あれば)
- [ ] リンターチェック(必要あれば)
- [ ] テスト(必要あれば)
- [ ] モック生成(必要あれば)

#### 4. 最終確認

- 全ての必須項目が完了していることを確認
- 検証が成功していること

### Phase 7: リモートリポジトリへの push とコメント返信

#### 1. リモートリポジトリへの push

- 変更内容を確認してコミット
- 修正内容をリモートリポジトリに push

#### 2. コメント ID を取得して個別返信する

**重要: 個別コメント返信は必ず Step1→Step2 の順番で実行してください**

##### Step1: コメント ID を確認する

`gh api 'repos/{ORGANIZATION}/{CURRENT_REPO}/pulls/{PULL_NUMBER}/comments' | jq '.[] | {id: .id, body: .body}'`

##### Step2: 修正対象のコメント ID ごとに個別で返信する

**重要**

- コメントする際は「by Claude Code」の文字を追加してください
- 🔴 必須修正項目と 🟡 推奨修正項目で実際に修正したもののみに返信する
- 🟢 質問・議論項目には返信しない（別途回答が必要）
- 各コメントに対して具体的な修正内容を記載する

```
gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/{ORGANIZATION}/{CURRENT_REPO}/pulls/{PULL_NUMBER}/comments/{COMMENT_ID}/replies -f 'body=test_comment'
```

例：

````
# コメントID 000001 （コメントアウト削除）への返信
gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/{ORGANIZATION}/{CURRENT_REPO}/pulls/{PULL_NUMBER}/comments/{COMMENT_ID}/replies -f 'body=修正しました。コメントアウトを削除しました。

by Claude Code'
`​``

#### 3. レビュー再依頼
- レビューを再依頼
- 修正内容の要約をコメントで追加

### Phase 8: ユーザーへの作業結果出力

**出力フォーマット**
```markdown
### 作業内容
作業内容を全てまとめて記載する
{作業内容}

### 未回答の質問
未回答の質問が存在する場合はこちらに記載する
{未回答質問}
`​``
````
`````
