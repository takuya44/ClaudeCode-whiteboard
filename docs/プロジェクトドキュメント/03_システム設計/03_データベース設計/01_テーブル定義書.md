# テーブル定義書

## 1. データベース概要

### 1.1 基本情報
- **データベース名**: whiteboard_db
- **RDBMS**: PostgreSQL 15
- **文字エンコーディング**: UTF-8
- **タイムゾーン**: UTC
- **照合順序**: C

### 1.2 命名規則
- **テーブル名**: スネークケース（例: `drawing_elements`）
- **カラム名**: スネークケース（例: `created_at`）
- **インデックス名**: `idx_{テーブル名}_{カラム名}`
- **外部キー名**: `fk_{テーブル名}_{参照テーブル名}`

### 1.3 実装状況
- **実装済みテーブル**: users, whiteboards, drawing_elements, whiteboard_collaborators, tags, whiteboard_tags
- **未実装テーブル**: user_sessions, activity_logs（将来実装予定）

## 2. 実装済みテーブル一覧

### 2.1 ユーザー関連テーブル

#### users（ユーザー）
```sql
CREATE TYPE userrole AS ENUM ('user', 'admin');

CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    avatar VARCHAR(500),
    role userrole NOT NULL DEFAULT 'user',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);
```

**カラム説明**:
| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PK | ユーザーID（UUID） |
| email | VARCHAR(255) | UNIQUE, NOT NULL, INDEX | メールアドレス |
| name | VARCHAR(255) | NOT NULL | ユーザー名 |
| password_hash | VARCHAR(255) | NOT NULL | ハッシュ化パスワード |
| avatar | VARCHAR(500) | NULL | アバター画像URL |
| role | userrole | NOT NULL, DEFAULT 'user' | ユーザー権限（user/admin） |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 更新日時 |

### 2.2 ホワイトボード関連テーブル

#### whiteboards（ホワイトボード）
```sql
CREATE TABLE whiteboards (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    is_public BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);
```

**カラム説明**:
| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PK | ホワイトボードID |
| title | VARCHAR(255) | NOT NULL | タイトル |
| description | TEXT | NULL | 説明 |
| owner_id | UUID | FK(users.id), NOT NULL | 作成者ID |
| is_public | BOOLEAN | NOT NULL, DEFAULT false | 公開フラグ |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 更新日時 |

#### drawing_elements（描画要素）
```sql
CREATE TYPE drawingtype AS ENUM (
    'pen', 'line', 'rectangle', 'circle', 'text', 'sticky'
);

CREATE TABLE drawing_elements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    whiteboard_id UUID NOT NULL REFERENCES whiteboards(id) ON DELETE CASCADE,
    type drawingtype NOT NULL,
    x FLOAT NOT NULL,
    y FLOAT NOT NULL,
    width FLOAT,
    height FLOAT,
    end_x FLOAT,
    end_y FLOAT,
    points JSON,  -- ペンストローク用
    color VARCHAR(7) NOT NULL,  -- HEX形式 #RRGGBB
    stroke_width INTEGER,
    fill_color VARCHAR(7),  -- HEX形式 #RRGGBB
    text_content TEXT,
    font_size INTEGER,
    font_family VARCHAR(100),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);
```

**カラム説明**:
| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PK | 描画要素ID |
| whiteboard_id | UUID | FK(whiteboards.id), NOT NULL | ホワイトボードID |
| type | drawingtype | NOT NULL | 描画タイプ |
| x | FLOAT | NOT NULL | X座標 |
| y | FLOAT | NOT NULL | Y座標 |
| width | FLOAT | NULL | 幅（矩形、円用） |
| height | FLOAT | NULL | 高さ（矩形用） |
| end_x | FLOAT | NULL | 終点X座標（線用） |
| end_y | FLOAT | NULL | 終点Y座標（線用） |
| points | JSON | NULL | ペンストローク座標配列 |
| color | VARCHAR(7) | NOT NULL | 線の色（HEX） |
| stroke_width | INTEGER | NULL | 線の太さ |
| fill_color | VARCHAR(7) | NULL | 塗りつぶし色（HEX） |
| text_content | TEXT | NULL | テキスト内容 |
| font_size | INTEGER | NULL | フォントサイズ |
| font_family | VARCHAR(100) | NULL | フォントファミリー |
| user_id | UUID | FK(users.id), NULL | 作成者ID |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 更新日時 |

**points JSON形式例**:
```json
[{"x": 100, "y": 200}, {"x": 150, "y": 250}, {"x": 200, "y": 300}]
```

### 2.3 タグ関連テーブル

#### tags（タグ）
```sql
CREATE TABLE tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,
    color VARCHAR(7),  -- HEX形式 #RRGGBB
    usage_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);
```

**カラム説明**:
| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PK | タグID |
| name | VARCHAR(100) | UNIQUE, NOT NULL, INDEX | タグ名 |
| color | VARCHAR(7) | NULL | タグ色（HEX形式） |
| usage_count | INTEGER | NOT NULL, DEFAULT 0 | 使用回数 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 更新日時 |

#### whiteboard_tags（ホワイトボード-タグ関連）
```sql
CREATE TABLE whiteboard_tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    whiteboard_id UUID NOT NULL REFERENCES whiteboards(id) ON DELETE CASCADE,
    tag_id UUID NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    deleted_at TIMESTAMP WITH TIME ZONE,  -- 論理削除用
    UNIQUE(whiteboard_id, tag_id)
);
```

**カラム説明**:
| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PK | 関連ID |
| whiteboard_id | UUID | FK(whiteboards.id), NOT NULL | ホワイトボードID |
| tag_id | UUID | FK(tags.id), NOT NULL | タグID |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 作成日時 |
| deleted_at | TIMESTAMP WITH TIME ZONE | NULL | 論理削除日時 |

### 2.4 コラボレーション関連テーブル

#### whiteboard_collaborators（ホワイトボードコラボレーター）
```sql
CREATE TYPE permission AS ENUM ('view', 'edit', 'admin');

CREATE TABLE whiteboard_collaborators (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    whiteboard_id UUID NOT NULL REFERENCES whiteboards(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    permission permission NOT NULL DEFAULT 'edit',
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UNIQUE(whiteboard_id, user_id)
);
```

**カラム説明**:
| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PK | コラボレーターID |
| whiteboard_id | UUID | FK(whiteboards.id), NOT NULL | ホワイトボードID |
| user_id | UUID | FK(users.id), NOT NULL | ユーザーID |
| permission | permission | NOT NULL, DEFAULT 'edit' | 権限レベル（view/edit/admin） |
| joined_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT now() | 参加日時 |

## 3. 将来実装予定テーブル

### 3.1 セッション・履歴関連テーブル

#### user_sessions（ユーザーセッション）
```sql
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    session_token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_accessed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### activity_logs（アクティビティログ）
```sql
CREATE TYPE activity_type AS ENUM (
    'user_login', 'user_logout', 'whiteboard_created', 'whiteboard_updated',
    'whiteboard_shared', 'element_created', 'element_updated', 'element_deleted'
);

CREATE TABLE activity_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    whiteboard_id UUID REFERENCES whiteboards(id) ON DELETE SET NULL,
    activity_type activity_type NOT NULL,
    details JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## 4. インデックス定義

### 4.1 実装済みインデックス
```sql
-- users テーブル
CREATE UNIQUE INDEX ix_users_email ON users(email);

-- tags テーブル
CREATE UNIQUE INDEX ix_tags_name ON tags(name);
CREATE INDEX idx_tags_usage ON tags(usage_count DESC, name);

-- 外部キー関連のインデックス（PostgreSQLで自動作成）
-- whiteboards.owner_id
-- drawing_elements.whiteboard_id
-- drawing_elements.user_id
-- whiteboard_collaborators.whiteboard_id
-- whiteboard_collaborators.user_id
-- whiteboard_tags.whiteboard_id
-- whiteboard_tags.tag_id
```

### 4.2 検索最適化インデックス（実装済み）
```sql
-- 高度な検索機能用インデックス

-- 1. 全文検索用GINインデックス（タイトルと説明）
CREATE INDEX idx_whiteboard_fulltext
ON whiteboards
USING gin((
    setweight(to_tsvector('english', coalesce(title, '')), 'A') ||
    setweight(to_tsvector('english', coalesce(description, '')), 'B')
));

-- 2. 複合検索用インデックス
CREATE INDEX idx_whiteboard_search_composite
ON whiteboards (owner_id, created_at DESC, updated_at DESC);

-- 3. タグ検索用複合インデックス
CREATE INDEX idx_whiteboard_tags_composite
ON whiteboard_tags (tag_id, whiteboard_id);

-- 4. 権限チェック用インデックス
CREATE INDEX idx_collaborators_permission
ON whiteboard_collaborators (user_id, whiteboard_id, permission);

-- 5. パブリックホワイトボード用パーシャルインデックス
CREATE INDEX idx_whiteboards_public
ON whiteboards (is_public)
WHERE is_public = true;
```

### 4.3 推奨追加インデックス（パフォーマンス向上用）
```sql
-- drawing_elements テーブル
CREATE INDEX idx_drawing_elements_type ON drawing_elements(type);
CREATE INDEX idx_drawing_elements_user_id ON drawing_elements(user_id);
```

## 5. 制約・トリガー

### 5.1 実装済み制約
```sql
-- ユニーク制約
ALTER TABLE users ADD CONSTRAINT users_email_key UNIQUE (email);
ALTER TABLE whiteboard_collaborators ADD CONSTRAINT _whiteboard_user_uc UNIQUE (whiteboard_id, user_id);

-- 外部キー制約（CASCADE削除）
ALTER TABLE whiteboards ADD CONSTRAINT whiteboards_owner_id_fkey 
    FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE drawing_elements ADD CONSTRAINT drawing_elements_whiteboard_id_fkey 
    FOREIGN KEY (whiteboard_id) REFERENCES whiteboards(id) ON DELETE CASCADE;
ALTER TABLE drawing_elements ADD CONSTRAINT drawing_elements_user_id_fkey 
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL;
ALTER TABLE whiteboard_collaborators ADD CONSTRAINT whiteboard_collaborators_whiteboard_id_fkey 
    FOREIGN KEY (whiteboard_id) REFERENCES whiteboards(id) ON DELETE CASCADE;
ALTER TABLE whiteboard_collaborators ADD CONSTRAINT whiteboard_collaborators_user_id_fkey 
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

### 5.2 推奨CHECK制約
```sql
-- drawing_elements テーブル
ALTER TABLE drawing_elements ADD CONSTRAINT chk_color 
    CHECK (color ~ '^#[0-9A-Fa-f]{6}$');
ALTER TABLE drawing_elements ADD CONSTRAINT chk_fill_color 
    CHECK (fill_color IS NULL OR fill_color ~ '^#[0-9A-Fa-f]{6}$');
ALTER TABLE drawing_elements ADD CONSTRAINT chk_stroke_width 
    CHECK (stroke_width IS NULL OR stroke_width > 0);
ALTER TABLE drawing_elements ADD CONSTRAINT chk_font_size 
    CHECK (font_size IS NULL OR font_size > 0);
```

### 5.3 更新日時トリガー
```sql
-- 更新日時自動更新関数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- トリガー作成
CREATE TRIGGER update_users_updated_at 
    BEFORE UPDATE ON users 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_whiteboards_updated_at 
    BEFORE UPDATE ON whiteboards 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_drawing_elements_updated_at 
    BEFORE UPDATE ON drawing_elements 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 6. パーティショニング戦略（将来実装）

### 6.1 activity_logs パーティショニング
```sql
-- 月次パーティショニング
CREATE TABLE activity_logs_y2024m07 PARTITION OF activity_logs
    FOR VALUES FROM ('2024-07-01') TO ('2024-08-01');

CREATE TABLE activity_logs_y2024m08 PARTITION OF activity_logs
    FOR VALUES FROM ('2024-08-01') TO ('2024-09-01');
```

## 7. セキュリティ設定

### 7.1 ロール・権限設定
```sql
-- アプリケーション用ロール
CREATE ROLE app_user WITH LOGIN PASSWORD 'secure_password';
GRANT CONNECT ON DATABASE whiteboard_db TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO app_user;

-- 読み取り専用ロール
CREATE ROLE app_readonly WITH LOGIN PASSWORD 'readonly_password';
GRANT CONNECT ON DATABASE whiteboard_db TO app_readonly;
GRANT USAGE ON SCHEMA public TO app_readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_readonly;
```

## 8. データ保持ポリシー

### 8.1 削除ポリシー
- **activity_logs**: 3年後自動削除
- **user_sessions**: 期限切れ後1週間で削除
- **論理削除**: drawing_elements は is_deleted フラグで管理

### 8.2 アーカイブ戦略
- **古いアクティビティログ**: 年次でアーカイブテーブルに移動
- **非アクティブユーザー**: 2年未ログインで無効化

## 9. リレーション詳細

### 9.1 実装済みリレーション
- **users → whiteboards**: 1対多（owner_id）
- **users → drawing_elements**: 1対多（user_id）
- **users → whiteboard_collaborators**: 1対多（user_id）
- **whiteboards → drawing_elements**: 1対多（whiteboard_id）
- **whiteboards → whiteboard_collaborators**: 1対多（whiteboard_id）
- **whiteboards → whiteboard_tags**: 1対多（whiteboard_id）
- **tags → whiteboard_tags**: 1対多（tag_id）
- **users ↔ whiteboards**: 多対多（whiteboard_collaboratorsテーブル経由）
- **whiteboards ↔ tags**: 多対多（whiteboard_tagsテーブル経由）

### 9.2 カスケード動作
- **ユーザー削除時**:
  - 所有するホワイトボード: CASCADE削除
  - 作成した描画要素: SET NULL（user_idがNULLになる）
  - コラボレーター情報: CASCADE削除
- **ホワイトボード削除時**:
  - 描画要素: CASCADE削除
  - コラボレーター情報: CASCADE削除
  - ホワイトボード-タグ関連: CASCADE削除
- **タグ削除時**:
  - ホワイトボード-タグ関連: CASCADE削除

---
**作成日**: 2024年7月6日  
**更新日**: 2025年8月14日  
**作成者**: データベース設計チーム  
**更新者**: 検索機能実装チーム  
**版数**: 3.0.0（検索機能対応版）