# ER図（Entity Relationship Diagram）

## 概要
本資料は、リアルタイム協調ホワイトボードアプリケーションのデータベース構造を示すER図です。

## 実装状況
- **実装済みテーブル**: users, whiteboards, drawing_elements, whiteboard_collaborators, tags, whiteboard_tags
- **未実装テーブル**: user_sessions, activity_logs（将来実装予定）

## 実装済みER図

```mermaid
erDiagram
    users ||--o{ whiteboards : "owns"
    users ||--o{ drawing_elements : "creates"
    users ||--o{ whiteboard_collaborators : "has"
    
    whiteboards ||--o{ drawing_elements : "contains"
    whiteboards ||--o{ whiteboard_collaborators : "has"
    whiteboards ||--o{ whiteboard_tags : "has"
    
    tags ||--o{ whiteboard_tags : "used_in"
    
    users {
        uuid id PK
        varchar email UK
        varchar name
        varchar password_hash
        varchar avatar
        enum role
        timestamp created_at
        timestamp updated_at
    }
    
    whiteboards {
        uuid id PK
        varchar title
        text description
        uuid owner_id FK
        boolean is_public
        timestamp created_at
        timestamp updated_at
    }
    
    drawing_elements {
        uuid id PK
        uuid whiteboard_id FK
        enum type
        float x
        float y
        float width
        float height
        float end_x
        float end_y
        json points
        varchar color
        integer stroke_width
        varchar fill_color
        text text_content
        integer font_size
        varchar font_family
        uuid user_id FK
        timestamp created_at
        timestamp updated_at
    }
    
    whiteboard_collaborators {
        uuid id PK
        uuid whiteboard_id FK
        uuid user_id FK
        enum permission
        timestamp joined_at
    }
    
    tags {
        uuid id PK
        varchar name UK
        varchar color
        integer usage_count
        timestamp created_at
        timestamp updated_at
    }
    
    whiteboard_tags {
        uuid id PK
        uuid whiteboard_id FK
        uuid tag_id FK
        timestamp created_at
        timestamp deleted_at
    }
```

## 将来実装予定ER図

```mermaid
erDiagram
    users ||--o{ user_sessions : "has"
    users ||--o{ activity_logs : "generates"
    whiteboards ||--o{ activity_logs : "tracked_in"
    
    user_sessions {
        uuid id PK
        uuid user_id FK
        varchar session_token UK
        timestamp expires_at
        timestamp created_at
        timestamp last_accessed_at
    }
    
    activity_logs {
        uuid id PK
        uuid user_id FK
        uuid whiteboard_id FK
        enum activity_type
        jsonb details
        inet ip_address
        text user_agent
        timestamp created_at
    }
```

## 実装済みテーブル関係説明

### 1. users（ユーザー）
- **主キー**: id (UUID)
- **ユニークキー**: email
- **ENUM型**: role ('user', 'admin')
- **説明**: システムのユーザー情報を管理

### 2. whiteboards（ホワイトボード）
- **主キー**: id (UUID)
- **外部キー**: owner_id → users.id
- **説明**: ホワイトボードの基本情報を管理
- **関係**: 各ホワイトボードは1人のオーナー（users）を持つ

### 3. drawing_elements（描画要素）
- **主キー**: id (UUID)
- **外部キー**: 
  - whiteboard_id → whiteboards.id
  - user_id → users.id
- **ENUM型**: type ('pen', 'line', 'rectangle', 'circle', 'text', 'sticky')
- **説明**: ホワイトボード上の描画要素を管理
- **関係**: 各描画要素は1つのホワイトボードに属し、1人の作成者を持つ

### 4. whiteboard_collaborators（コラボレーター）
- **主キー**: id (UUID)
- **外部キー**:
  - whiteboard_id → whiteboards.id
  - user_id → users.id
- **ユニーク制約**: (whiteboard_id, user_id)
- **ENUM型**: permission ('view', 'edit', 'admin')
- **説明**: ホワイトボードの共有・権限情報を管理
- **関係**: ユーザーとホワイトボードの多対多関係を表現

### 5. tags（タグ）
- **主キー**: id (UUID)
- **ユニークキー**: name
- **説明**: ホワイトボードのタグ情報を管理
- **関係**: ホワイトボードとの多対多関係をサポート

### 6. whiteboard_tags（ホワイトボード-タグ関連）
- **主キー**: id (UUID)
- **外部キー**:
  - whiteboard_id → whiteboards.id
  - tag_id → tags.id
- **ユニーク制約**: (whiteboard_id, tag_id)
- **説明**: ホワイトボードとタグの多対多関係を管理
- **特殊機能**: deleted_atで論理削除をサポート

## 将来実装予定テーブル説明

### 5. user_sessions（セッション）
- **主キー**: id (UUID)
- **外部キー**: user_id → users.id
- **ユニークキー**: session_token
- **説明**: ユーザーのセッション情報を管理
- **関係**: 各セッションは1人のユーザーに属する

### 6. activity_logs（アクティビティログ）
- **主キー**: id (UUID)
- **外部キー**:
  - user_id → users.id (NULL可)
  - whiteboard_id → whiteboards.id (NULL可)
- **説明**: システム全体のアクティビティを記録
- **関係**: ユーザーやホワイトボードの活動を追跡

## データ型説明

### 実装済みENUM型
- **userrole**: 'user', 'admin'
- **drawingtype**: 'pen', 'line', 'rectangle', 'circle', 'text', 'sticky'
- **permission**: 'view', 'edit', 'admin'

### JSON型
- **points**: ペンストローク用の座標配列 [{"x": 10, "y": 20}, ...]

### 将来実装予定ENUM型
- **activity_type**: 'user_login', 'user_logout', 'whiteboard_created', など

### 将来実装予定JSONB型
- **details**: アクティビティの詳細情報

## 関係性の詳細

### 実装済み関係

1. **1対多関係**
   - users → whiteboards（1人のユーザーが複数のホワイトボードを所有）
   - users → drawing_elements（1人のユーザーが複数の描画要素を作成）
   - whiteboards → drawing_elements（1つのホワイトボードが複数の描画要素を含む）
   - whiteboards → whiteboard_tags（1つのホワイトボードが複数のタグを持つ）
   - tags → whiteboard_tags（1つのタグが複数のホワイトボードで使用）

2. **多対多関係**
   - users ↔ whiteboards（whiteboard_collaboratorsテーブルを介して）
   - whiteboards ↔ tags（whiteboard_tagsテーブルを介して）

3. **カスケード削除**
   - ユーザー削除時：
     - 所有するホワイトボード: CASCADE削除
     - 作成した描画要素: SET NULL（user_idがNULLになる）
     - コラボレーター情報: CASCADE削除
   - ホワイトボード削除時：
     - 描画要素: CASCADE削除
     - コラボレーター情報: CASCADE削除
     - ホワイトボード-タグ関連: CASCADE削除
   - タグ削除時：
     - ホワイトボード-タグ関連: CASCADE削除

### 将来実装予定関係

1. **1対多関係**
   - users → user_sessions（1人のユーザーが複数のセッションを持つ）
   - users → activity_logs（1人のユーザーが複数のアクティビティを生成）
   - whiteboards → activity_logs（1つのホワイトボードが複数のアクティビティを持つ）

## インデックス戦略

### 実装済みインデックス
- users.emailにユニークインデックス
- tags.nameにユニークインデックス
- 外部キーカラムにPostgreSQLが自動でインデックスを作成

### 検索最適化インデックス（実装済み）
- **全文検索用GINインデックス**: タイトルと説明の高速検索
- **複合インデックス**: 作成者、日付での効率的な絞り込み
- **タグ検索用インデックス**: タグでの高速フィルタリング
- **権限チェック用インデックス**: コラボレーター権限の高速チェック

## 関連資料
- [テーブル定義書](./01_テーブル定義書.md)
- [API設計書](../04_API設計/)
- [データベース移行手順](../../04_開発ガイドライン/)

---
**作成日**: 2024年7月6日  
**更新日**: 2025年8月14日  
**作成者**: データベース設計チーム  
**更新者**: 検索機能実装チーム  
**版数**: 3.0.0（検索機能対応版）