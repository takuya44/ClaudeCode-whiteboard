# システム全体構成図

## 1. システム概要

### 1.1 システム構成
ホワイトボード共有プラットフォームは、以下の主要コンポーネントで構成されます：

- **フロントエンド**: Vue.js 3.3.8 (Composition API) + TypeScript 5.2.0 によるSPAアプリケーション
- **ビルドツール**: Vite 5.0.0 による高速開発環境
- **状態管理**: Pinia 2.1.7 による軽量状態管理
- **UIフレームワーク**: Tailwind CSS 3.3.6 による効率的スタイリング
- **バックエンド**: FastAPI 0.104.1 + Python 3.x による REST API サーバー
- **ORM**: SQLAlchemy 2.0.23 + Alembic 1.12.1 によるデータベース管理
- **リアルタイム通信**: FastAPI WebSocket + websockets 12.0 によるリアルタイム通信
- **データベース**: PostgreSQL 15 によるデータ永続化
- **認証**: JWT (python-jose 3.3.0) + passlib 1.7.4 による認証機能
- **コンテナ**: Docker Compose による完全コンテナ化
- **ファイルストレージ**: AWS S3 による画像・ファイル保存
- **CDN**: CloudFront による静的コンテンツ配信

## 2. アーキテクチャ図

### 2.1 全体構成図

```
[ユーザー]
    ↓ HTTPS
[CloudFront CDN]
    ↓
[Application Load Balancer]
    ↓
[Web Server Layer]
┌─────────────────────┐
│   Vue.js 3.3.8      │
│   TypeScript 5.2.0  │
│   Vite 5.0.0        │
│   Pinia 2.1.7       │
│   Tailwind CSS 3.3.6│
└─────────────────────┘
    ↓ REST API / WebSocket
[Application Layer]
┌─────────────────────┐
│   FastAPI 0.104.1   │
│   SQLAlchemy 2.0.23 │
│   ┌─────────────┐   │
│   │ WebSocket   │   │
│   │ (websockets)│   │
│   └─────────────┘   │
└─────────────────────┘
    ↓ SQL
[Database Layer]
┌─────────────────────┐
│   PostgreSQL        │
│   (Primary + Read   │
│   Replica)          │
└─────────────────────┘

[File Storage]
┌─────────────────────┐
│   AWS S3            │
│   (Images/Files)    │
└─────────────────────┘
```

### 2.2 ネットワーク構成図

```
Internet
    ↓
[Route 53 DNS]
    ↓
[CloudFront]
    ↓
[ALB (Application Load Balancer)]
    ↓
[Public Subnet]
┌─────────────────────────────┐
│  Web Server (EC2)           │
│  ┌─────────────────────┐    │
│  │ Nginx (Reverse      │    │
│  │ Proxy)              │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ FastAPI 0.104.1     │    │
│  │ (Uvicorn 0.24.0)    │    │
│  └─────────────────────┘    │
└─────────────────────────────┘
    ↓
[Private Subnet]
┌─────────────────────────────┐
│  Database (RDS PostgreSQL)  │
│  ┌─────────────────────┐    │
│  │ Primary Instance    │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ Read Replica        │    │
│  └─────────────────────┘    │
└─────────────────────────────┘
```

## 3. コンポーネント詳細

### 3.1 フロントエンド層

#### 技術スタック
- **フレームワーク**: Vue.js 3.3.8
- **言語**: TypeScript 5.2.0
- **ビルドツール**: Vite 5.0.0
- **状態管理**: Pinia 2.1.7
- **ルーティング**: Vue Router 4.2.5
- **UIフレームワーク**: Tailwind CSS 3.3.6
- **HTTPクライアント**: Axios 1.6.2
- **ユーティリティ**: @vueuse/core 10.5.0
- **描画ライブラリ**: HTML5 Canvas (カスタム実装)

#### 主要機能
- ホワイトボード描画・編集
- リアルタイム同期表示
- ユーザー認証・管理
- ファイルアップロード・ダウンロード

### 3.2 バックエンド層

#### 技術スタック
- **フレームワーク**: FastAPI 0.104.1
- **言語**: Python 3.x
- **ASGIサーバー**: Uvicorn 0.24.0
- **ORM**: SQLAlchemy 2.0.23
- **マイグレーション**: Alembic 1.12.1
- **認証**: JWT (python-jose 3.3.0) + passlib 1.7.4
- **リアルタイム**: FastAPI WebSocket + websockets 12.0
- **バリデーション**: Pydantic 2.5.0
- **設定管理**: pydantic-settings 2.1.0
- **データベースドライバー**: psycopg2-binary 2.9.9

#### 主要機能
- REST API の提供
- WebSocket 通信制御
- ユーザー認証・認可
- データベース操作
- ファイル管理

### 3.3 データベース層

#### 技術スタック
- **RDBMS**: PostgreSQL 15
- **接続プール**: SQLAlchemy 2.0.23 Pool
- **マイグレーション**: Alembic 1.12.1
- **データベースドライバー**: psycopg2-binary 2.9.9

#### 主要テーブル（実装済み）
- **users**（ユーザー）- UUID主キー、認証情報
- **whiteboards**（ホワイトボード）- UUID主キー、タイトル、作成者
- **drawing_elements**（描画要素）- リアルタイム描画データ（JSON形式）
- **whiteboard_collaborators**（コラボレーター）- ホワイトボード共有関係
- **描画タイプ**: pen, line, rectangle, circle, text, sticky（Enum管理）

### 3.4 ストレージ層

#### 技術スタック
- **ファイルストレージ**: AWS S3
- **CDN**: CloudFront
- **画像処理**: Sharp (Node.js)

#### 保存データ
- ユーザーアバター画像
- ホワイトボード画像エクスポート
- アップロード画像・ファイル

## 4. データフロー

### 4.1 ユーザー認証フロー

```
[ユーザー] → [ログイン要求] → [Backend API]
                                    ↓
[JWT Token] ← [認証成功] ← [Password検証]
    ↓                           ↓
[Frontend] → [Token保存] → [Database]
    ↓
[認証済みAPI呼び出し]
```

### 4.2 リアルタイム描画フロー

```
[ユーザーA描画] → [Vue Frontend] → [WebSocket] → [FastAPI Backend]
                                                       ↓
[Database保存] ← [描画データ] ← [FastAPI WebSocket Server]
                                                       ↓
[ユーザーB,C,D] ← [Vue Frontend] ← [WebSocket] ← [Broadcast]
```

### 4.3 ファイルアップロードフロー

```
[ファイル選択] → [Vue Frontend] → [Presigned URL要求] → [FastAPI Backend]
                                                          ↓
[S3 Upload] ← [URL受信] ← [Presigned URL生成] ← [AWS S3 API]
    ↓
[Upload完了] → [FastAPI API] → [PostgreSQL] → [メタデータ保存]
```

## 5. 非機能要件への対応

### 5.1 可用性
- **冗長化**: Multi-AZ配置
- **負荷分散**: ALB による負荷分散
- **オートスケーリング**: EC2 Auto Scaling
- **ヘルスチェック**: アプリケーション・データベース

### 5.2 性能
- **キャッシュ**: Redis による セッション・APIレスポンスキャッシュ
- **CDN**: CloudFront による静的コンテンツキャッシュ
- **DB最適化**: Read Replica、インデックス最適化
- **圧縮**: Gzip 圧縮、画像最適化

### 5.3 拡張性
- **水平スケーリング**: ALB + Auto Scaling
- **垂直スケーリング**: インスタンスサイズ変更
- **データベース**: Read Replica、分割対応
- **マイクロサービス**: 将来的な分割設計

### 5.4 セキュリティ
- **通信暗号化**: HTTPS/WSS
- **認証・認可**: JWT + RBAC
- **ネットワーク**: VPC、セキュリティグループ
- **データ暗号化**: データベース・S3暗号化

## 6. 外部システム連携

### 6.1 AWS サービス連携

```
[Application]
    ├─ EC2 (Web Server)
    ├─ RDS (PostgreSQL)
    ├─ S3 (File Storage)
    ├─ CloudFront (CDN)
    ├─ ALB (Load Balancer)
    ├─ ElastiCache (Redis)
    ├─ CloudWatch (Monitoring)
    └─ IAM (Access Control)
```

### 6.2 外部 API 連携
- **メール送信**: Amazon SES
- **監視・ログ**: CloudWatch Logs
- **エラー追跡**: Sentry (オプション)

## 7. 開発・運用環境

### 7.1 環境構成

| 環境 | 用途 | インフラ | データベース |
|------|------|----------|--------------|
| Local | 開発 | Docker | PostgreSQL (Container) |
| Development | 開発共有 | AWS (小規模) | RDS (t3.micro) |
| Staging | テスト | AWS (本番同等) | RDS (t3.small) |
| Production | 本番 | AWS (冗長化) | RDS (t3.medium) |

### 7.2 CI/CD パイプライン

```
[GitHub Repository]
    ↓ Push
[GitHub Actions]
    ↓ Build & Test
[Docker Image Build]
    ↓ Deploy
[AWS ECR]
    ↓ ECS Deploy
[Production Environment]
```

## 8. システム制限事項

### 8.1 技術制限
- **同時接続数**: 100ユーザー/ホワイトボード（Phase 1）
- **ファイルサイズ**: 最大10MB/ファイル
- **ストレージ**: 初期容量100GB
- **API レート制限**: 1000req/min/user

### 8.2 ブラウザ制限
- **WebSocket対応**: 必須
- **Canvas API**: 必須
- **File API**: 必須
- **LocalStorage**: 必須

## 9. 監視・ログ設計

### 9.1 監視項目
- **システムメトリクス**: CPU、メモリ、ディスク、ネットワーク
- **アプリケーションメトリクス**: レスポンス時間、エラー率、スループット
- **ビジネスメトリクス**: アクティブユーザー、同時接続数、利用時間

### 9.2 ログ設計
- **アクセスログ**: Nginx ログ
- **アプリケーションログ**: Python logging (構造化ログ)
- **エラーログ**: FastAPI例外ハンドリング
- **監査ログ**: ユーザー操作履歴

---
**作成日**: 2024年7月6日  
**作成者**: [システムアーキテクト名]  
**レビュー者**: [技術リーダー名]  
**承認者**: [CTO名]  
**版数**: 1.0.0