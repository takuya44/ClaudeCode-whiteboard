# レビューガイドライン

## 1. レビュー方針

### 1.1 基本理念
- **品質向上**: コードの品質・保守性・セキュリティの向上
- **知識共有**: チーム内の技術知識・ベストプラクティスの共有
- **継続学習**: 建設的なフィードバックによる成長促進

### 1.2 レビュー目的
1. **機能性確認**: 要件通りの実装・動作確認
2. **コード品質**: 可読性・保守性・パフォーマンス
3. **セキュリティ**: 脆弱性・情報漏洩リスクの防止
4. **設計整合性**: アーキテクチャ・設計原則との一貫性

## 2. レビュープロセス

### 2.1 レビューフロー
```
1. プルリクエスト作成
   ↓
2. 自動チェック実行
   ↓
3. レビュー担当者アサイン
   ↓
4. コードレビュー実施
   ↓
5. フィードバック対応
   ↓
6. 承認・マージ
```

### 2.2 レビュー担当者
- **main ブランチ**: 2名以上のレビュー必須
- **develop ブランチ**: 1名以上のレビュー必須
- **feature ブランチ**: 1名以上のレビュー推奨

### 2.3 レビュー期限
- **通常**: 2営業日以内
- **緊急**: 24時間以内
- **大規模**: 1週間以内（事前相談必須）

## 3. レビュー観点

### 3.1 機能性チェック
```markdown
## 機能性確認
- [ ] 要件通りの実装
- [ ] エラーハンドリング適切
- [ ] 入力バリデーション実装
- [ ] 境界条件の考慮
- [ ] レスポンス・パフォーマンス
```

#### 3.1.1 実装例チェック
```typescript
// ✅ 良い例
const validateWhiteboardData = (data: WhiteboardCreate): ValidationResult => {
  const errors: string[] = [];
  
  if (!data.title?.trim()) {
    errors.push('タイトルは必須です');
  }
  
  if (data.title && data.title.length > 200) {
    errors.push('タイトルは200文字以内で入力してください');
  }
  
  if (data.description && data.description.length > 1000) {
    errors.push('説明は1000文字以内で入力してください');
  }
  
  return {
    isValid: errors.length === 0,
    errors
  };
};

// ❌ 悪い例
const validateWhiteboardData = (data: any) => {
  if (!data.title) return false;
  return true;
};
```

### 3.2 コード品質チェック

#### 3.2.1 可読性
```typescript
// ✅ 良い例 - 明確な関数名・コメント
/**
 * ホワイトボード上の描画要素を追加する
 * @param whiteboardId - ホワイトボードID
 * @param element - 追加する描画要素
 * @param userId - 追加者のユーザーID
 * @returns 追加された描画要素
 */
const addDrawingElement = async (
  whiteboardId: string,
  element: DrawingElementCreate,
  userId: string
): Promise<DrawingElement> => {
  // 権限チェック
  await validateUserPermission(userId, whiteboardId, 'write');
  
  // 要素データの正規化
  const normalizedElement = normalizeDrawingElement(element);
  
  // データベースに保存
  const savedElement = await drawingElementRepository.create({
    ...normalizedElement,
    whiteboardId,
    createdBy: userId
  });
  
  // WebSocketで他のユーザーに通知
  await notifyDrawingElementAdded(whiteboardId, savedElement);
  
  return savedElement;
};

// ❌ 悪い例 - 不明確な関数名・コメント不足
const addEl = async (wbId: string, el: any, uid: string) => {
  if (!await checkPerm(uid, wbId)) throw new Error('no perm');
  const saved = await repo.create({...el, wbId, uid});
  await notify(wbId, saved);
  return saved;
};
```

#### 3.2.2 パフォーマンス
```python
# ✅ 良い例 - 効率的なデータベースクエリ
async def get_whiteboard_with_elements(
    db: AsyncSession, 
    whiteboard_id: str
) -> Whiteboard:
    # 1回のクエリで関連データを含めて取得
    query = (
        select(Whiteboard)
        .options(
            selectinload(Whiteboard.elements),
            selectinload(Whiteboard.collaborators)
        )
        .where(Whiteboard.id == whiteboard_id)
    )
    
    result = await db.execute(query)
    return result.scalar_one_or_none()

# ❌ 悪い例 - N+1問題
async def get_whiteboard_with_elements_bad(
    db: AsyncSession, 
    whiteboard_id: str
) -> Whiteboard:
    # ホワイトボード取得
    whiteboard = await db.get(Whiteboard, whiteboard_id)
    
    # 各要素を個別に取得（N+1問題）
    elements = []
    for element_id in whiteboard.element_ids:
        element = await db.get(DrawingElement, element_id)
        elements.append(element)
    
    whiteboard.elements = elements
    return whiteboard
```

### 3.3 セキュリティチェック

#### 3.3.1 認証・認可
```python
# ✅ 良い例 - 適切な認証・認可チェック
@router.put("/whiteboards/{whiteboard_id}")
async def update_whiteboard(
    whiteboard_id: str,
    update_data: WhiteboardUpdate,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    # 認証チェック（current_userが取得済み）
    if not current_user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="認証が必要です"
        )
    
    # 権限チェック
    whiteboard = await get_whiteboard_or_404(db, whiteboard_id)
    if not await has_edit_permission(current_user.id, whiteboard):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="編集権限がありません"
        )
    
    # 入力データの検証
    validated_data = validate_whiteboard_update(update_data)
    
    # 更新実行
    updated_whiteboard = await whiteboard_service.update(
        db, whiteboard_id, validated_data
    )
    
    return WhiteboardResponse.model_validate(updated_whiteboard)

# ❌ 悪い例 - 権限チェック不足
@router.put("/whiteboards/{whiteboard_id}")
async def update_whiteboard_bad(
    whiteboard_id: str,
    update_data: dict,  # 型チェック不足
    db: AsyncSession = Depends(get_db)
):
    # 認証・認可チェックなし
    await whiteboard_service.update(db, whiteboard_id, update_data)
    return {"status": "updated"}
```

#### 3.3.2 データ検証
```typescript
// ✅ 良い例 - 適切な入力検証
const validateDrawingElement = (element: DrawingElementInput): ValidationResult => {
  const errors: string[] = [];
  
  // 必須フィールドチェック
  if (!element.type) {
    errors.push('描画タイプは必須です');
  }
  
  // 列挙型チェック
  const validTypes = ['pen', 'line', 'rectangle', 'circle', 'text', 'sticky'];
  if (element.type && !validTypes.includes(element.type)) {
    errors.push('無効な描画タイプです');
  }
  
  // 位置データチェック
  if (!element.position || typeof element.position.x !== 'number' || typeof element.position.y !== 'number') {
    errors.push('位置データが無効です');
  }
  
  // サイズ制限チェック
  if (element.content && element.content.length > 1000) {
    errors.push('コンテンツは1000文字以内で入力してください');
  }
  
  return {
    isValid: errors.length === 0,
    errors
  };
};

// ❌ 悪い例 - 検証不足
const validateDrawingElement = (element: any) => {
  return element.type && element.position;
};
```

### 3.4 設計整合性チェック

#### 3.4.1 アーキテクチャ遵守
```typescript
// ✅ 良い例 - 適切なレイヤー分離
// Service層 - ビジネスロジック
class WhiteboardService {
  async shareWhiteboard(
    whiteboardId: string,
    userId: string,
    permission: Permission
  ): Promise<void> {
    // ビジネスルール検証
    await this.validateSharingRules(whiteboardId, userId, permission);
    
    // データ永続化
    await this.collaboratorRepository.create({
      whiteboardId,
      userId,
      permission
    });
    
    // ドメインイベント発行
    await this.eventBus.publish(
      new WhiteboardSharedEvent(whiteboardId, userId, permission)
    );
  }
}

// Controller層 - HTTPリクエスト処理
@Controller('/whiteboards')
class WhiteboardController {
  @Post('/:id/share')
  async shareWhiteboard(
    @Param('id') whiteboardId: string,
    @Body() shareData: ShareWhiteboardRequest,
    @CurrentUser() currentUser: User
  ) {
    await this.whiteboardService.shareWhiteboard(
      whiteboardId,
      shareData.userId,
      shareData.permission
    );
    
    return { message: '共有設定が完了しました' };
  }
}

// ❌ 悪い例 - レイヤー境界の混在
@Controller('/whiteboards')
class WhiteboardController {
  @Post('/:id/share')
  async shareWhiteboard(
    @Param('id') whiteboardId: string,
    @Body() shareData: any
  ) {
    // Controller内でビジネスロジックを実装（不適切）
    const whiteboard = await this.db.query('SELECT * FROM whiteboards WHERE id = ?', [whiteboardId]);
    if (whiteboard.owner_id !== shareData.userId) {
      throw new Error('権限がありません');
    }
    
    await this.db.query('INSERT INTO collaborators ...', []);
    await this.websocket.broadcast('whiteboard_shared', shareData);
    
    return { message: '共有設定が完了しました' };
  }
}
```

## 4. レビューコメント

### 4.1 コメント分類
- **🔴 Critical**: 修正必須（セキュリティ・機能不具合）
- **🟡 Major**: 修正推奨（パフォーマンス・設計）
- **🟢 Minor**: 修正任意（コードスタイル・可読性）
- **💡 Suggestion**: 改善提案
- **❓ Question**: 質問・確認

### 4.2 コメント例

#### 4.2.1 建設的なコメント
```markdown
🔴 Critical: 
SQLインジェクション脆弱性があります。
プリペアードステートメントまたはORMを使用してください。

🟡 Major:
この処理はN+1問題を引き起こす可能性があります。
`selectinload`を使用してリレーションを一度にロードすることを検討してください。

🟢 Minor:
変数名 `data` は汎用的すぎます。
`whiteboardData` のようにより具体的な名前を使用すると可読性が向上します。

💡 Suggestion:
この処理はユーティリティ関数として抽出できそうです。
再利用可能性を高めるため、共通モジュールに移動することを検討してください。

❓ Question:
この条件分岐はどのようなケースを想定していますか？
コメントで補足いただけますでしょうか。
```

#### 4.2.2 避けるべきコメント
```markdown
❌ 非建設的なコメント
- "このコードは良くない"
- "間違っている"
- "なぜこう書いたの？"

✅ 建設的なコメント
- "〜の理由により、〜の方法を推奨します"
- "〜の場合を考慮して、〜を追加してください"
- "〜の観点から、〜を確認させてください"
```

## 5. レビューチェックリスト

### 5.1 フロントエンド チェックリスト
```markdown
## Vue.js/TypeScript レビューチェックリスト

### 基本事項
- [ ] TypeScript型定義が適切
- [ ] Props/Emitsの型定義が明確
- [ ] コンポーネントの単一責任原則遵守
- [ ] 適切なライフサイクル使用

### パフォーマンス
- [ ] 不要な再レンダリングを回避
- [ ] 大きなリストでvirtualizationを使用
- [ ] 画像の遅延読み込み実装
- [ ] バンドルサイズの最適化

### セキュリティ
- [ ] XSS対策（v-html使用時）
- [ ] CSRF対策
- [ ] 機密データの適切な取り扱い
- [ ] 認証状態の適切な管理

### アクセシビリティ
- [ ] 適切なセマンティックHTML
- [ ] キーボードナビゲーション対応
- [ ] スクリーンリーダー対応
- [ ] 色コントラスト確保
```

### 5.2 バックエンド チェックリスト
```markdown
## FastAPI/Python レビューチェックリスト

### 基本事項
- [ ] 型ヒントが適切
- [ ] Pydanticスキーマ定義
- [ ] 適切なHTTPステータスコード
- [ ] エラーハンドリング実装

### セキュリティ
- [ ] 認証・認可チェック
- [ ] 入力データバリデーション
- [ ] SQLインジェクション対策
- [ ] 機密データの暗号化

### データベース
- [ ] 効率的なクエリ実装
- [ ] N+1問題の回避
- [ ] 適切なトランザクション管理
- [ ] インデックスの適切な使用

### パフォーマンス
- [ ] 非同期処理の適切な使用
- [ ] キャッシュ戦略の実装
- [ ] レスポンスサイズの最適化
- [ ] 重い処理の分割・並行処理
```

### 5.3 データベース チェックリスト
```markdown
## データベース レビューチェックリスト

### スキーマ設計
- [ ] 適切な正規化レベル
- [ ] 外部キー制約の設定
- [ ] インデックス設計
- [ ] 命名規則の遵守

### マイグレーション
- [ ] 後方互換性の確保
- [ ] ロールバック手順の確認
- [ ] 本番環境での実行計画
- [ ] パフォーマンス影響の評価

### セキュリティ
- [ ] 適切なアクセス権限
- [ ] 機密データの暗号化
- [ ] 監査ログの設定
- [ ] バックアップ戦略
```

## 6. 自動チェック設定

### 6.1 Pre-commit フック
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      
  - repo: https://github.com/psf/black
    rev: 22.3.0
    hooks:
      - id: black
        language_version: python3.11
        
  - repo: https://github.com/pycqa/flake8
    rev: 4.0.1
    hooks:
      - id: flake8
        
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v8.44.0
    hooks:
      - id: eslint
        files: \.(js|ts|vue)$
        types: [file]
```

### 6.2 GitHub Actions チェック
```yaml
# .github/workflows/code-quality.yml
name: Code Quality Check
on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run ESLint
        run: npm run lint
        
      - name: Run TypeScript check
        run: npm run type-check
        
      - name: Run Prettier check
        run: npm run format:check
        
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run security audit
        run: npm audit --audit-level moderate
        
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        with:
          args: --severity-threshold=medium
```

## 7. レビュー効率化

### 7.1 レビュー準備
```markdown
## プルリクエスト作成者のチェックリスト

### 自己レビュー
- [ ] 自分でコードを一通り確認
- [ ] 不要なコメント・デバッグコードを削除
- [ ] コミット履歴の整理
- [ ] 適切なコミットメッセージ

### ドキュメント
- [ ] プルリクエストの説明文記載
- [ ] 変更理由・影響範囲の明記
- [ ] テスト手順の記載
- [ ] 関連Issue・設計書の参照

### テスト
- [ ] 自動テストの実行・通過確認
- [ ] 手動テストの実行
- [ ] 異常系テストの実行
- [ ] パフォーマンステストの実行
```

### 7.2 効率的なレビュー
```markdown
## レビュー担当者のベストプラクティス

### 準備
- [ ] 変更内容・背景の理解
- [ ] 関連ドキュメントの確認
- [ ] 十分な時間の確保
- [ ] 適切な環境での確認

### レビュー実施
- [ ] 全体構造から詳細への順序
- [ ] 重要度の高い箇所を優先
- [ ] 建設的なフィードバック
- [ ] 理由を明確に説明

### フォローアップ
- [ ] 修正内容の再確認
- [ ] 継続的な改善提案
- [ ] 知識共有・ドキュメント化
- [ ] チーム内での共有
```

## 8. レビュー文化醸成

### 8.1 チーム方針
- **学習重視**: 失敗を責めず、学習機会と捉える
- **建設的**: 改善提案を具体的に提示
- **相互尊重**: 多様な意見・アプローチを尊重
- **継続改善**: レビュープロセス自体も改善

### 8.2 定期振り返り
```markdown
## 月次レビュー振り返り

### 振り返り観点
- [ ] レビューの質・効率性
- [ ] チーム内の知識共有状況
- [ ] 発見された問題の分析
- [ ] プロセス改善点の特定

### 改善アクション
- [ ] レビューガイドラインの更新
- [ ] チェックリストの改善
- [ ] 自動化の拡充
- [ ] 教育・研修の実施
```

## 9. トラブルシューティング

### 9.1 よくある問題
```markdown
## レビューでよく指摘される問題

### セキュリティ関連
- 認証・認可チェック不足
- 入力データバリデーション不足
- SQLインジェクション脆弱性
- 機密データの不適切な取り扱い

### パフォーマンス関連
- N+1問題
- 不要な再レンダリング
- 非効率なデータベースクエリ
- メモリリークの可能性

### 設計関連
- 単一責任原則違反
- 密結合
- 重複コード
- 適切でない抽象化
```

### 9.2 解決策テンプレート
```markdown
## 問題解決のアプローチ

### 1. 問題の特定
- 何が問題なのか明確化
- 影響範囲の特定
- 緊急度・重要度の評価

### 2. 解決策の検討
- 複数のアプローチを検討
- トレードオフの分析
- 既存コードへの影響評価

### 3. 実装・テスト
- 段階的な実装
- 十分なテストの実施
- レビューでの検証

### 4. 文書化・共有
- 解決策の文書化
- チーム内での共有
- 再発防止策の検討
```

---
**作成日**: 2024年7月6日  
**作成者**: [開発チームリーダー名]  
**レビュー者**: [シニアエンジニア名]  
**承認者**: [技術リーダー名]  
**版数**: 1.0.0