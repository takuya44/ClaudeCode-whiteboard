# ブランチ戦略

## 1. ブランチ戦略概要

### 1.1 採用戦略
**Git Flow** を基本とし、小規模チーム向けにカスタマイズした**Modified Git Flow**を採用

### 1.2 基本方針
- **main**: 本番環境用の安定版
- **develop**: 開発統合用ブランチ
- **feature**: 機能開発用ブランチ
- **hotfix**: 緊急修正用ブランチ
- **release**: リリース準備用ブランチ

## 2. ブランチ構造

### 2.1 ブランチ階層
```
main (本番)
├── hotfix/fix-critical-bug
├── release/v1.1.0
└── develop (開発統合)
    ├── feature/user-authentication
    ├── feature/whiteboard-sharing
    └── feature/realtime-collaboration
```

### 2.2 ブランチ詳細

#### 2.2.1 main ブランチ
- **用途**: 本番環境へのデプロイ
- **保護**: 直接プッシュ禁止
- **マージ**: release・hotfix からのみ
- **タグ**: バージョンタグ付与

```bash
# ✅ 推奨
git checkout main
git merge --no-ff release/v1.1.0
git tag -a v1.1.0 -m "Release version 1.1.0"
git push origin main --tags
```

#### 2.2.2 develop ブランチ
- **用途**: 開発統合・テスト
- **マージ**: feature からのプルリクエスト
- **デプロイ**: ステージング環境

```bash
# ✅ 推奨
git checkout develop
git pull origin develop
git merge --no-ff feature/user-authentication
git push origin develop
```

#### 2.2.3 feature ブランチ
- **命名**: `feature/{機能名}`
- **起点**: develop ブランチ
- **マージ先**: develop ブランチ

```bash
# ✅ 推奨
git checkout develop
git pull origin develop
git checkout -b feature/user-authentication
# 開発作業
git add .
git commit -m "feat: ユーザー認証機能実装"
git push origin feature/user-authentication
```

#### 2.2.4 release ブランチ
- **命名**: `release/v{バージョン}`
- **起点**: develop ブランチ
- **マージ先**: main・develop ブランチ

```bash
# ✅ 推奨
git checkout develop
git pull origin develop
git checkout -b release/v1.1.0
# バージョン更新・バグ修正
git commit -m "chore: バージョン1.1.0準備"
git push origin release/v1.1.0
```

#### 2.2.5 hotfix ブランチ
- **命名**: `hotfix/{修正内容}`
- **起点**: main ブランチ
- **マージ先**: main・develop ブランチ

```bash
# ✅ 推奨
git checkout main
git pull origin main
git checkout -b hotfix/fix-critical-security-bug
# 緊急修正
git commit -m "fix: セキュリティ脆弱性修正"
git push origin hotfix/fix-critical-security-bug
```

## 3. 命名規則

### 3.1 ブランチ命名
```bash
# ✅ 推奨
feature/user-authentication
feature/whiteboard-sharing
feature/realtime-collaboration
bugfix/fix-drawing-sync-issue
hotfix/fix-security-vulnerability
release/v1.1.0

# ❌ 非推奨
feature/UserAuth
feature/wb-share
fix-bug
hotfix1
```

### 3.2 コミット命名
```bash
# ✅ 推奨
feat: ホワイトボード共有機能追加
fix: 描画同期問題修正
docs: API仕様書更新
style: ESLint警告修正
refactor: ユーザー認証処理リファクタリング
test: ユニットテスト追加
chore: 依存関係更新

# ❌ 非推奨
add feature
bug fix
update
```

## 4. ワークフロー

### 4.1 機能開発フロー

#### Step 1: 機能ブランチ作成
```bash
# 1. develop ブランチを最新化
git checkout develop
git pull origin develop

# 2. feature ブランチ作成
git checkout -b feature/user-authentication

# 3. 機能開発
# ... 開発作業 ...

# 4. コミット
git add .
git commit -m "feat: ユーザー認証API実装"

# 5. プッシュ
git push origin feature/user-authentication
```

#### Step 2: プルリクエスト作成
```bash
# GitHub CLI使用例
gh pr create \
  --title "feat: ユーザー認証機能実装" \
  --body "$(cat <<'EOF'
## 概要
ユーザー登録・ログイン機能を実装しました。

## 変更内容
- [x] ユーザー登録API実装
- [x] ログインAPI実装  
- [x] JWT認証実装
- [x] パスワードハッシュ化
- [x] バリデーション追加

## テスト
- [x] ユニットテスト追加
- [x] 統合テスト実行
- [x] 手動テスト完了

## 確認事項
- [x] ESLint・Prettier通過
- [x] 型チェック完了
- [x] テストカバレッジ80%以上
EOF
)" \
  --base develop \
  --head feature/user-authentication
```

#### Step 3: コードレビュー・マージ
```bash
# レビュー後、マージ
git checkout develop
git pull origin develop
git merge --no-ff feature/user-authentication
git push origin develop

# feature ブランチ削除
git branch -d feature/user-authentication
git push origin --delete feature/user-authentication
```

### 4.2 リリースフロー

#### Step 1: リリースブランチ作成
```bash
# 1. develop から release ブランチ作成
git checkout develop
git pull origin develop
git checkout -b release/v1.1.0

# 2. バージョン更新
# package.json, pyproject.toml などのバージョン更新
git commit -m "chore: バージョン1.1.0準備"
git push origin release/v1.1.0
```

#### Step 2: リリーステスト・修正
```bash
# リリーステスト実行
npm run test:e2e
pytest tests/

# 必要に応じてバグ修正
git commit -m "fix: リリーステストで発見されたバグ修正"
git push origin release/v1.1.0
```

#### Step 3: main・develop へマージ
```bash
# 1. main へマージ
git checkout main
git pull origin main
git merge --no-ff release/v1.1.0
git tag -a v1.1.0 -m "Release version 1.1.0"
git push origin main --tags

# 2. develop へマージ
git checkout develop
git pull origin develop
git merge --no-ff release/v1.1.0
git push origin develop

# 3. release ブランチ削除
git branch -d release/v1.1.0
git push origin --delete release/v1.1.0
```

### 4.3 ホットフィックスフロー

#### Step 1: hotfix ブランチ作成
```bash
# 1. main から hotfix ブランチ作成
git checkout main
git pull origin main
git checkout -b hotfix/fix-critical-security-bug

# 2. 緊急修正
# ... 修正作業 ...

# 3. コミット
git commit -m "fix: セキュリティ脆弱性修正"
git push origin hotfix/fix-critical-security-bug
```

#### Step 2: テスト・確認
```bash
# テスト実行
npm run test
pytest tests/

# セキュリティスキャン
npm audit
pip-audit
```

#### Step 3: main・develop へマージ
```bash
# 1. main へマージ
git checkout main
git pull origin main
git merge --no-ff hotfix/fix-critical-security-bug
git tag -a v1.0.1 -m "Hotfix version 1.0.1"
git push origin main --tags

# 2. develop へマージ
git checkout develop
git pull origin develop
git merge --no-ff hotfix/fix-critical-security-bug
git push origin develop

# 3. hotfix ブランチ削除
git branch -d hotfix/fix-critical-security-bug
git push origin --delete hotfix/fix-critical-security-bug
```

## 5. ブランチ保護設定

### 5.1 GitHub ブランチ保護
```yaml
# .github/settings.yml
branches:
  - name: main
    protection:
      required_status_checks:
        strict: true
        contexts:
          - "continuous-integration"
          - "security-scan"
          - "code-quality"
      enforce_admins: true
      required_pull_request_reviews:
        required_approving_review_count: 2
        dismiss_stale_reviews: true
        require_code_owner_reviews: true
      restrictions:
        users: []
        teams: ["core-team"]
  
  - name: develop
    protection:
      required_status_checks:
        strict: true
        contexts:
          - "continuous-integration"
          - "code-quality"
      required_pull_request_reviews:
        required_approving_review_count: 1
        dismiss_stale_reviews: true
```

### 5.2 プルリクエストテンプレート
```markdown
<!-- .github/pull_request_template.md -->
## 概要
<!-- 変更内容の簡潔な説明 -->

## 変更内容
- [ ] 新機能追加
- [ ] バグ修正
- [ ] リファクタリング
- [ ] ドキュメント更新
- [ ] テスト追加

## 関連Issue
<!-- 関連するIssue番号 -->
Closes #

## テスト
- [ ] ユニットテスト追加・更新
- [ ] 統合テスト実行
- [ ] 手動テスト完了
- [ ] E2Eテスト実行

## 確認事項
- [ ] ESLint・Prettier通過
- [ ] 型チェック完了
- [ ] テストカバレッジ維持
- [ ] セキュリティスキャン通過
- [ ] パフォーマンス影響なし

## スクリーンショット
<!-- UI変更がある場合のスクリーンショット -->

## 追加コメント
<!-- その他の補足情報 -->
```

## 6. 自動化設定

### 6.1 GitHub Actions 設定
```yaml
# .github/workflows/feature-branch.yml
name: Feature Branch CI
on:
  push:
    branches: [ 'feature/*' ]
  pull_request:
    branches: [ develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run linter
        run: npm run lint
        
      - name: Run tests
        run: npm run test:coverage
        
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

### 6.2 自動ブランチ削除
```yaml
# .github/workflows/cleanup.yml
name: Cleanup Merged Branches
on:
  pull_request:
    types: [closed]
    branches: [develop, main]

jobs:
  cleanup:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Delete branch
        uses: dawidd6/action-delete-branch@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branches: ${{ github.event.pull_request.head.ref }}
```

## 7. チーム運用ルール

### 7.1 コードレビュー
- **必須レビュー**: 全てのプルリクエスト
- **レビュー担当**: 2名以上（mainブランチ）、1名以上（developブランチ）
- **レビュー観点**: 機能性、可読性、セキュリティ、パフォーマンス

### 7.2 マージ方針
- **feature → develop**: Squash and merge
- **develop → main**: Merge commit
- **hotfix → main**: Merge commit

### 7.3 コンフリクト解決
```bash
# 1. 最新のdevelopを取得
git checkout develop
git pull origin develop

# 2. feature ブランチでrebase
git checkout feature/user-authentication
git rebase develop

# 3. コンフリクト解決
# ... 手動解決 ...

# 4. rebase続行
git rebase --continue

# 5. force push
git push origin feature/user-authentication --force-with-lease
```

## 8. トラブルシューティング

### 8.1 よくある問題と対処

#### 問題1: リベースでコンフリクト
```bash
# 対処法
git rebase --abort  # リベース中止
git merge develop   # マージで解決
```

#### 問題2: 誤ったブランチへのコミット
```bash
# 対処法
git log --oneline -n 5
git reset --soft HEAD~1  # 最新コミットを取り消し
git stash
git checkout correct-branch
git stash pop
git commit -m "正しいブランチへのコミット"
```

#### 問題3: プッシュ済みコミットの修正
```bash
# 対処法（注意：他の人が使用中の場合は避ける）
git commit --amend -m "修正されたコミットメッセージ"
git push origin feature/branch-name --force-with-lease
```

## 9. 品質管理

### 9.1 マージ前チェックリスト
- [ ] すべてのテストが通過
- [ ] ESLint・Prettier・Black 通過
- [ ] 型チェック完了
- [ ] セキュリティスキャン通過
- [ ] コードカバレッジ80%以上
- [ ] パフォーマンステスト実行

### 9.2 定期メンテナンス
- **週次**: 不要ブランチの削除
- **月次**: 依存関係の更新
- **四半期**: ブランチ戦略の見直し

---
**作成日**: 2024年7月6日  
**作成者**: [開発チームリーダー名]  
**レビュー者**: [シニアエンジニア名]  
**承認者**: [技術リーダー名]  
**版数**: 1.0.0