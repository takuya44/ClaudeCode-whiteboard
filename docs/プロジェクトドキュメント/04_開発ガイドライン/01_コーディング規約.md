# コーディング規約

## 1. 規約概要

### 1.1 目的
- チーム全体のコード品質統一
- 保守性・可読性の向上
- コードレビューの効率化

### 1.2 適用範囲
- フロントエンド: Vue.js 3.3.8 + TypeScript 5.2.0
- バックエンド: Python 3.x + FastAPI 0.104.1
- データベース: PostgreSQL 15

## 2. フロントエンド規約

### 2.1 TypeScript コーディング規約

#### 2.1.1 基本規則
```typescript
// ✅ 推奨
interface User {
  id: string;
  name: string;
  email: string;
}

const createUser = (userData: Partial<User>): User => {
  return {
    id: generateId(),
    name: userData.name || '',
    email: userData.email || ''
  };
};

// ❌ 非推奨
var user = {
  id: null,
  name: '',
  email: ''
};
```

#### 2.1.2 命名規則
- **変数・関数**: camelCase
- **クラス・インターフェース**: PascalCase
- **定数**: UPPER_SNAKE_CASE
- **ファイル名**: kebab-case

```typescript
// ✅ 推奨
interface WhiteboardElement {
  id: string;
  type: DrawingType;
}

const MAX_DRAWING_ELEMENTS = 1000;
const calculateCanvasSize = (width: number, height: number): CanvasSize => {};

// ❌ 非推奨
interface whiteboard_element {}
const Max_Drawing_Elements = 1000;
const CalculateCanvasSize = () => {};
```

#### 2.1.3 型定義
```typescript
// ✅ 推奨 - 厳密な型定義
type DrawingType = 'pen' | 'line' | 'rectangle' | 'circle' | 'text' | 'sticky';

interface Position {
  x: number;
  y: number;
}

interface DrawingElement {
  id: string;
  type: DrawingType;
  position: Position;
  style: StyleProperties;
  content?: string;
}

// ❌ 非推奨 - any型の使用
const drawingElement: any = {};
```

### 2.2 Vue.js 規約

#### 2.2.1 Composition API スタイル
```vue
<!-- ✅ 推奨 -->
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useWhiteboardStore } from '@/stores/whiteboard';

interface Props {
  whiteboardId: string;
  mode: 'edit' | 'view';
}

const props = defineProps<Props>();
const whiteboardStore = useWhiteboardStore();

const isEditing = ref(false);
const elementCount = computed(() => whiteboardStore.elements.length);

const startEditing = (): void => {
  if (props.mode === 'edit') {
    isEditing.value = true;
  }
};

onMounted(() => {
  whiteboardStore.loadWhiteboard(props.whiteboardId);
});
</script>

<template>
  <div class="whiteboard-container">
    <canvas 
      :class="{ 'editing': isEditing }"
      @mousedown="startEditing"
    />
    <div class="element-count">
      要素数: {{ elementCount }}
    </div>
  </div>
</template>
```

#### 2.2.2 コンポーネント規約
```typescript
// ✅ 推奨 - コンポーネント分割
// components/whiteboard/WhiteboardCanvas.vue
// components/whiteboard/WhiteboardToolbar.vue  
// components/whiteboard/DrawingElement.vue

// ❌ 非推奨 - 巨大コンポーネント
// components/Whiteboard.vue (500行以上)
```

### 2.3 Pinia State Management

#### 2.3.1 Store 設計
```typescript
// stores/whiteboard.ts
import { defineStore } from 'pinia';
import { ref, computed } from 'vue';

export const useWhiteboardStore = defineStore('whiteboard', () => {
  // State
  const whiteboards = ref<Whiteboard[]>([]);
  const currentWhiteboard = ref<Whiteboard | null>(null);
  const isLoading = ref(false);

  // Getters
  const currentWhiteboardId = computed(() => currentWhiteboard.value?.id || '');
  const hasElements = computed(() => 
    (currentWhiteboard.value?.elements.length || 0) > 0
  );

  // Actions
  const loadWhiteboard = async (id: string): Promise<void> => {
    isLoading.value = true;
    try {
      const whiteboard = await whiteboardApi.getById(id);
      currentWhiteboard.value = whiteboard;
    } catch (error) {
      console.error('ホワイトボード読み込みエラー:', error);
    } finally {
      isLoading.value = false;
    }
  };

  const addElement = (element: DrawingElement): void => {
    if (currentWhiteboard.value) {
      currentWhiteboard.value.elements.push(element);
    }
  };

  return {
    // State
    whiteboards,
    currentWhiteboard,
    isLoading,
    // Getters
    currentWhiteboardId,
    hasElements,
    // Actions
    loadWhiteboard,
    addElement
  };
});
```

### 2.4 ESLint・Prettier 設定

#### 2.4.1 ESLint 設定
```json
{
  "extends": [
    "@vue/eslint-config-typescript",
    "@vue/eslint-config-prettier"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/explicit-function-return-type": "warn",
    "vue/component-name-in-template-casing": ["error", "PascalCase"],
    "vue/max-attributes-per-line": ["error", { "singleline": 3 }]
  }
}
```

#### 2.4.2 Prettier 設定
```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 80,
  "bracketSpacing": true,
  "arrowParens": "avoid"
}
```

## 3. バックエンド規約

### 3.1 Python コーディング規約

#### 3.1.1 基本規則（PEP 8準拠）
```python
# ✅ 推奨
from typing import List, Optional, Dict, Any
from datetime import datetime
import uuid

class WhiteboardService:
    def __init__(self, repository: WhiteboardRepository) -> None:
        self.repository = repository
    
    async def create_whiteboard(
        self, 
        title: str, 
        owner_id: str,
        description: Optional[str] = None
    ) -> Whiteboard:
        whiteboard = Whiteboard(
            id=str(uuid.uuid4()),
            title=title,
            owner_id=owner_id,
            description=description,
            created_at=datetime.utcnow()
        )
        
        return await self.repository.create(whiteboard)

# ❌ 非推奨
class whiteboardService:
    def createWhiteboard(self,title,owner_id,description=None):
        whiteboard=Whiteboard(id=str(uuid.uuid4()),title=title,owner_id=owner_id,description=description)
        return self.repository.create(whiteboard)
```

#### 3.1.2 FastAPI スタイル
```python
# ✅ 推奨
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession

from app.core.deps import get_db, get_current_user
from app.schemas.whiteboard import WhiteboardCreate, WhiteboardResponse
from app.services.whiteboard import WhiteboardService

router = APIRouter(prefix="/whiteboards", tags=["whiteboards"])

@router.post(
    "/",
    response_model=WhiteboardResponse,
    status_code=status.HTTP_201_CREATED,
    summary="ホワイトボード作成",
    description="新しいホワイトボードを作成します"
)
async def create_whiteboard(
    whiteboard_data: WhiteboardCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
) -> WhiteboardResponse:
    """
    ホワイトボードを作成し、作成者を所有者に設定します。
    
    Args:
        whiteboard_data: ホワイトボード作成データ
        db: データベースセッション
        current_user: 現在のユーザー
        
    Returns:
        作成されたホワイトボード情報
        
    Raises:
        HTTPException: 作成に失敗した場合
    """
    try:
        service = WhiteboardService(db)
        whiteboard = await service.create_whiteboard(
            title=whiteboard_data.title,
            owner_id=current_user.id,
            description=whiteboard_data.description
        )
        return WhiteboardResponse.model_validate(whiteboard)
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ホワイトボード作成エラー: {str(e)}"
        )
```

#### 3.1.3 Pydantic スキーマ
```python
# ✅ 推奨
from pydantic import BaseModel, Field, validator
from typing import Optional, List
from datetime import datetime
from enum import Enum

class DrawingType(str, Enum):
    PEN = "pen"
    LINE = "line"
    RECTANGLE = "rectangle"
    CIRCLE = "circle"
    TEXT = "text"
    STICKY = "sticky"

class WhiteboardCreate(BaseModel):
    title: str = Field(..., min_length=1, max_length=200)
    description: Optional[str] = Field(None, max_length=1000)
    is_public: bool = Field(default=False)
    
    @validator('title')
    def validate_title(cls, v):
        if not v.strip():
            raise ValueError('タイトルは空白のみにできません')
        return v.strip()

class WhiteboardResponse(BaseModel):
    id: str
    title: str
    description: Optional[str]
    owner_id: str
    is_public: bool
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True
```

### 3.2 SQLAlchemy モデル規約

#### 3.2.1 モデル定義
```python
# ✅ 推奨
from sqlalchemy import Column, String, Boolean, DateTime, ForeignKey, Text
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship, declarative_base
from sqlalchemy.sql import func
import uuid

Base = declarative_base()

class Whiteboard(Base):
    __tablename__ = "whiteboards"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    title = Column(String(200), nullable=False, index=True)
    description = Column(Text, nullable=True)
    owner_id = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False)
    is_public = Column(Boolean, default=False, nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(
        DateTime(timezone=True), 
        server_default=func.now(), 
        onupdate=func.now()
    )
    
    # Relationships
    owner = relationship("User", back_populates="whiteboards")
    elements = relationship("DrawingElement", back_populates="whiteboard")
    collaborators = relationship("WhiteboardCollaborator", back_populates="whiteboard")
    
    def __repr__(self) -> str:
        return f"<Whiteboard(id={self.id}, title='{self.title}')>"
```

### 3.3 Black・Flake8 設定

#### 3.3.1 Black 設定
```toml
# pyproject.toml
[tool.black]
line-length = 88
target-version = ['py311']
include = '\.pyi?$'
extend-exclude = '''
/(
  migrations
  | .venv
)/
'''
```

#### 3.3.2 Flake8 設定
```ini
# .flake8
[flake8]
max-line-length = 88
extend-ignore = E203, W503
exclude = 
    .git,
    __pycache__,
    .venv,
    migrations
per-file-ignores = 
    __init__.py:F401
```

## 4. データベース規約

### 4.1 命名規則
- **テーブル名**: snake_case（複数形）
- **カラム名**: snake_case
- **インデックス名**: `idx_{table}_{column}`
- **外部キー名**: `fk_{table}_{ref_table}`

### 4.2 マイグレーション規約
```python
# ✅ 推奨 - 明確なマイグレーション
"""Add whiteboard sharing functionality

Revision ID: 001_add_whiteboard_sharing
Revises: 000_initial_schema
Create Date: 2024-07-06 10:00:00.000000
"""

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

def upgrade():
    # Create whiteboard_collaborators table
    op.create_table(
        'whiteboard_collaborators',
        sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('whiteboard_id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('user_id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('permission', sa.Enum('viewer', 'editor', 'admin', name='permission_level'), nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
        sa.PrimaryKeyConstraint('id'),
        sa.ForeignKeyConstraint(['whiteboard_id'], ['whiteboards.id'], name='fk_collaborators_whiteboard'),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='fk_collaborators_user'),
        sa.UniqueConstraint('whiteboard_id', 'user_id', name='uq_collaborators_whiteboard_user')
    )
    
    # Create indexes
    op.create_index('idx_collaborators_whiteboard_id', 'whiteboard_collaborators', ['whiteboard_id'])
    op.create_index('idx_collaborators_user_id', 'whiteboard_collaborators', ['user_id'])

def downgrade():
    op.drop_table('whiteboard_collaborators')
```

## 5. Git コミット規約

### 5.1 コミットメッセージ
```
# ✅ 推奨
feat: ホワイトボード共有機能の実装

- コラボレーター招待API追加
- リアルタイム同期機能実装
- 権限管理システム構築

# ❌ 非推奨
fix bug
update code
```

### 5.2 コミットタイプ
- `feat`: 新機能追加
- `fix`: バグ修正
- `docs`: ドキュメント更新
- `style`: コードスタイル修正
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `chore`: その他の変更

## 6. エラーハンドリング規約

### 6.1 フロントエンド
```typescript
// ✅ 推奨
import { ElMessage } from 'element-plus';

const handleApiError = (error: AxiosError): void => {
  if (error.response?.status === 401) {
    router.push('/login');
    ElMessage.error('ログインが必要です');
  } else if (error.response?.status === 403) {
    ElMessage.error('アクセス権限がありません');
  } else {
    ElMessage.error('予期しないエラーが発生しました');
  }
  
  console.error('API Error:', error);
};
```

### 6.2 バックエンド
```python
# ✅ 推奨
from fastapi import HTTPException, status
import logging

logger = logging.getLogger(__name__)

async def create_whiteboard(whiteboard_data: WhiteboardCreate) -> Whiteboard:
    try:
        # ビジネスロジック
        whiteboard = await whiteboard_service.create(whiteboard_data)
        logger.info(f"ホワイトボード作成成功: {whiteboard.id}")
        return whiteboard
        
    except ValidationError as e:
        logger.warning(f"バリデーションエラー: {e}")
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"入力データエラー: {str(e)}"
        )
    except Exception as e:
        logger.error(f"ホワイトボード作成エラー: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="ホワイトボード作成に失敗しました"
        )
```

## 7. パフォーマンス規約

### 7.1 フロントエンド最適化
```vue
<!-- ✅ 推奨 - 遅延読み込み -->
<script setup lang="ts">
import { defineAsyncComponent } from 'vue';

const WhiteboardCanvas = defineAsyncComponent(() => 
  import('./components/WhiteboardCanvas.vue')
);
</script>
```

### 7.2 バックエンド最適化
```python
# ✅ 推奨 - 効率的なクエリ
from sqlalchemy.orm import selectinload

async def get_whiteboard_with_elements(whiteboard_id: str) -> Whiteboard:
    query = (
        select(Whiteboard)
        .options(selectinload(Whiteboard.elements))
        .where(Whiteboard.id == whiteboard_id)
    )
    result = await db.execute(query)
    return result.scalar_one_or_none()
```

## 8. セキュリティ規約

### 8.1 認証・認可
```python
# ✅ 推奨
from fastapi.security import HTTPBearer
from jose import JWTError, jwt

security = HTTPBearer()

async def get_current_user(token: str = Depends(security)) -> User:
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="無効な認証情報",
        headers={"WWW-Authenticate": "Bearer"},
    )
    
    try:
        payload = jwt.decode(token.credentials, SECRET_KEY, algorithms=[ALGORITHM])
        user_id: str = payload.get("sub")
        if user_id is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
    
    user = await get_user_by_id(user_id)
    if user is None:
        raise credentials_exception
    
    return user
```

### 8.2 データ検証
```python
# ✅ 推奨
from pydantic import validator
import re

class UserCreate(BaseModel):
    email: str
    password: str
    
    @validator('email')
    def validate_email(cls, v):
        pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(pattern, v):
            raise ValueError('有効なメールアドレスを入力してください')
        return v
    
    @validator('password')
    def validate_password(cls, v):
        if len(v) < 8:
            raise ValueError('パスワードは8文字以上で入力してください')
        return v
```

---
**作成日**: 2024年7月6日  
**作成者**: [開発チームリーダー名]  
**レビュー者**: [シニアエンジニア名]  
**承認者**: [技術リーダー名]  
**版数**: 1.0.0