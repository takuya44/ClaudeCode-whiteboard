# テスト戦略

## 1. テスト戦略概要

### 1.1 テスト方針
- **品質優先**: 80%以上のテストカバレッジ維持
- **継続的テスト**: CI/CDパイプラインでの自動テスト実行
- **階層化テスト**: ユニット・統合・E2Eテストの適切な組み合わせ

### 1.2 テストピラミッド
```
      🔺 E2Eテスト (10%)
       手動テスト・ブラウザ自動化
    
    🔺🔺 統合テスト (20%)
     API・データベース・WebSocket
  
  🔺🔺🔺 ユニットテスト (70%)
   関数・クラス・コンポーネント
```

### 1.3 技術スタック
- **フロントエンド**: Vitest + Vue Test Utils + Playwright
- **バックエンド**: pytest + pytest-asyncio + httpx
- **データベース**: pytest-postgresql + SQLAlchemy
- **E2E**: Playwright + Docker Compose

## 2. フロントエンドテスト

### 2.1 ユニットテスト（Vitest）

#### 2.1.1 コンポーネントテスト
```typescript
// tests/components/WhiteboardCanvas.test.ts
import { describe, it, expect, vi } from 'vitest';
import { mount } from '@vue/test-utils';
import { createPinia } from 'pinia';
import WhiteboardCanvas from '@/components/whiteboard/WhiteboardCanvas.vue';
import { useWhiteboardStore } from '@/stores/whiteboard';

describe('WhiteboardCanvas', () => {
  it('キャンバスが正しくレンダリングされる', () => {
    const wrapper = mount(WhiteboardCanvas, {
      global: {
        plugins: [createPinia()],
      },
      props: {
        whiteboardId: 'test-id',
        mode: 'edit'
      }
    });

    expect(wrapper.find('canvas').exists()).toBe(true);
    expect(wrapper.find('.canvas-container').classes()).toContain('editable');
  });

  it('描画開始時に適切なイベントが発火される', async () => {
    const wrapper = mount(WhiteboardCanvas, {
      global: {
        plugins: [createPinia()],
      },
      props: {
        whiteboardId: 'test-id',
        mode: 'edit'
      }
    });

    const canvas = wrapper.find('canvas');
    await canvas.trigger('mousedown', { clientX: 100, clientY: 100 });

    expect(wrapper.emitted('drawing-start')).toBeTruthy();
    expect(wrapper.emitted('drawing-start')[0]).toEqual([{
      x: 100,
      y: 100,
      tool: 'pen'
    }]);
  });
});
```

#### 2.1.2 Composables テスト
```typescript
// tests/composables/useDrawing.test.ts
import { describe, it, expect, vi } from 'vitest';
import { ref } from 'vue';
import { useDrawing } from '@/composables/useDrawing';

describe('useDrawing', () => {
  it('描画開始時に状態が正しく更新される', () => {
    const { isDrawing, startDrawing, currentTool } = useDrawing();

    expect(isDrawing.value).toBe(false);
    
    startDrawing({ x: 100, y: 100 });
    
    expect(isDrawing.value).toBe(true);
  });

  it('描画ツール変更が正しく機能する', () => {
    const { currentTool, setTool } = useDrawing();

    expect(currentTool.value).toBe('pen');
    
    setTool('rectangle');
    
    expect(currentTool.value).toBe('rectangle');
  });
});
```

#### 2.1.3 Store テスト
```typescript
// tests/stores/whiteboard.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { setActivePinia, createPinia } from 'pinia';
import { useWhiteboardStore } from '@/stores/whiteboard';

describe('WhiteboardStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
  });

  it('ホワイトボード作成が正しく機能する', async () => {
    const store = useWhiteboardStore();
    
    const whiteboardData = {
      title: 'テストホワイトボード',
      description: 'テスト用の説明'
    };

    await store.createWhiteboard(whiteboardData);

    expect(store.whiteboards).toHaveLength(1);
    expect(store.whiteboards[0].title).toBe('テストホワイトボード');
  });

  it('描画要素追加が正しく機能する', () => {
    const store = useWhiteboardStore();
    
    const element = {
      id: 'test-element',
      type: 'pen',
      position: { x: 100, y: 100 },
      style: { color: '#000000' }
    };

    store.addElement(element);

    expect(store.currentElements).toHaveLength(1);
    expect(store.currentElements[0]).toEqual(element);
  });
});
```

### 2.2 統合テスト

#### 2.2.1 API統合テスト
```typescript
// tests/integration/api.test.ts
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { setupServer } from 'msw/node';
import { rest } from 'msw';
import { whiteboardApi } from '@/services/api/whiteboard';

const server = setupServer(
  rest.post('/api/whiteboards', (req, res, ctx) => {
    return res(ctx.json({
      id: 'test-id',
      title: 'Test Whiteboard',
      created_at: new Date().toISOString()
    }));
  }),
  
  rest.get('/api/whiteboards/:id', (req, res, ctx) => {
    return res(ctx.json({
      id: req.params.id,
      title: 'Test Whiteboard',
      elements: []
    }));
  })
);

beforeAll(() => server.listen());
afterAll(() => server.close());

describe('Whiteboard API Integration', () => {
  it('ホワイトボード作成APIが正しく機能する', async () => {
    const result = await whiteboardApi.create({
      title: 'Test Whiteboard',
      description: 'Test description'
    });

    expect(result).toEqual({
      id: 'test-id',
      title: 'Test Whiteboard',
      created_at: expect.any(String)
    });
  });

  it('ホワイトボード取得APIが正しく機能する', async () => {
    const result = await whiteboardApi.getById('test-id');

    expect(result).toEqual({
      id: 'test-id',
      title: 'Test Whiteboard',
      elements: []
    });
  });
});
```

### 2.3 E2Eテスト（Playwright）

#### 2.3.1 主要機能テスト
```typescript
// tests/e2e/whiteboard.spec.ts
import { test, expect } from '@playwright/test';

test.describe('ホワイトボード機能', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login');
    await page.fill('[data-testid="email"]', 'test@example.com');
    await page.fill('[data-testid="password"]', 'password123');
    await page.click('[data-testid="login-button"]');
    await page.waitForURL('/dashboard');
  });

  test('ホワイトボード作成・編集が正しく機能する', async ({ page }) => {
    // ホワイトボード作成
    await page.click('[data-testid="create-whiteboard"]');
    await page.fill('[data-testid="title-input"]', 'E2Eテストホワイトボード');
    await page.click('[data-testid="create-button"]');
    
    // ホワイトボード画面への遷移確認
    await page.waitForURL(/\/whiteboard\/[a-zA-Z0-9-]+/);
    
    // キャンバスが表示されることを確認
    await expect(page.locator('[data-testid="whiteboard-canvas"]')).toBeVisible();
    
    // 描画テスト
    const canvas = page.locator('[data-testid="whiteboard-canvas"]');
    await canvas.click({ position: { x: 100, y: 100 } });
    await canvas.dragTo(canvas, { 
      sourcePosition: { x: 100, y: 100 },
      targetPosition: { x: 200, y: 200 }
    });
    
    // 描画要素が追加されたことを確認
    await expect(page.locator('[data-testid="element-count"]')).toContainText('1');
  });

  test('リアルタイム共有が正しく機能する', async ({ page, context }) => {
    // 2つ目のブラウザコンテキストを作成
    const secondPage = await context.newPage();
    
    // 1つ目のページでホワイトボード作成
    await page.click('[data-testid="create-whiteboard"]');
    await page.fill('[data-testid="title-input"]', '共有テストホワイトボード');
    await page.click('[data-testid="create-button"]');
    
    const url = page.url();
    
    // 2つ目のページで同じホワイトボードにアクセス
    await secondPage.goto(url);
    
    // 1つ目のページで描画
    const canvas1 = page.locator('[data-testid="whiteboard-canvas"]');
    await canvas1.click({ position: { x: 150, y: 150 } });
    
    // 2つ目のページで描画が同期されることを確認
    await expect(secondPage.locator('[data-testid="element-count"]')).toContainText('1');
  });
});
```

## 3. バックエンドテスト

### 3.1 ユニットテスト（pytest）

#### 3.1.1 サービス層テスト
```python
# tests/services/test_whiteboard_service.py
import pytest
from unittest.mock import AsyncMock, MagicMock
from app.services.whiteboard import WhiteboardService
from app.schemas.whiteboard import WhiteboardCreate
from app.models.whiteboard import Whiteboard

class TestWhiteboardService:
    @pytest.fixture
    def mock_repository(self):
        return AsyncMock()
    
    @pytest.fixture
    def service(self, mock_repository):
        return WhiteboardService(mock_repository)
    
    @pytest.mark.asyncio
    async def test_create_whiteboard_success(self, service, mock_repository):
        # Arrange
        whiteboard_data = WhiteboardCreate(
            title="テストホワイトボード",
            description="テスト用の説明"
        )
        
        expected_whiteboard = Whiteboard(
            id="test-id",
            title="テストホワイトボード",
            description="テスト用の説明",
            owner_id="user-id"
        )
        
        mock_repository.create.return_value = expected_whiteboard
        
        # Act
        result = await service.create_whiteboard(
            whiteboard_data, 
            owner_id="user-id"
        )
        
        # Assert
        assert result.title == "テストホワイトボード"
        assert result.description == "テスト用の説明"
        mock_repository.create.assert_called_once()
    
    @pytest.mark.asyncio
    async def test_get_whiteboard_by_id_success(self, service, mock_repository):
        # Arrange
        whiteboard_id = "test-id"
        expected_whiteboard = Whiteboard(
            id=whiteboard_id,
            title="テストホワイトボード"
        )
        
        mock_repository.get_by_id.return_value = expected_whiteboard
        
        # Act
        result = await service.get_whiteboard_by_id(whiteboard_id)
        
        # Assert
        assert result.id == whiteboard_id
        mock_repository.get_by_id.assert_called_once_with(whiteboard_id)
    
    @pytest.mark.asyncio
    async def test_get_whiteboard_by_id_not_found(self, service, mock_repository):
        # Arrange
        whiteboard_id = "non-existent-id"
        mock_repository.get_by_id.return_value = None
        
        # Act & Assert
        with pytest.raises(ValueError, match="ホワイトボードが見つかりません"):
            await service.get_whiteboard_by_id(whiteboard_id)
```

#### 3.1.2 API層テスト
```python
# tests/api/test_whiteboard_api.py
import pytest
from httpx import AsyncClient
from fastapi import status
from app.main import app

class TestWhiteboardAPI:
    @pytest.fixture
    async def client(self):
        async with AsyncClient(app=app, base_url="http://test") as client:
            yield client
    
    @pytest.fixture
    def auth_headers(self):
        # テスト用のJWTトークンを生成
        return {"Authorization": "Bearer test-token"}
    
    @pytest.mark.asyncio
    async def test_create_whiteboard_success(self, client, auth_headers):
        # Arrange
        whiteboard_data = {
            "title": "テストホワイトボード",
            "description": "テスト用の説明",
            "is_public": False
        }
        
        # Act
        response = await client.post(
            "/api/whiteboards",
            json=whiteboard_data,
            headers=auth_headers
        )
        
        # Assert
        assert response.status_code == status.HTTP_201_CREATED
        data = response.json()
        assert data["title"] == "テストホワイトボード"
        assert data["description"] == "テスト用の説明"
        assert "id" in data
        assert "created_at" in data
    
    @pytest.mark.asyncio
    async def test_create_whiteboard_invalid_data(self, client, auth_headers):
        # Arrange
        whiteboard_data = {
            "title": "",  # 空のタイトル
            "description": "テスト用の説明"
        }
        
        # Act
        response = await client.post(
            "/api/whiteboards",
            json=whiteboard_data,
            headers=auth_headers
        )
        
        # Assert
        assert response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY
        data = response.json()
        assert "title" in data["detail"][0]["loc"]
    
    @pytest.mark.asyncio
    async def test_get_whiteboard_unauthorized(self, client):
        # Act
        response = await client.get("/api/whiteboards/test-id")
        
        # Assert
        assert response.status_code == status.HTTP_401_UNAUTHORIZED
```

### 3.2 データベーステスト

#### 3.2.1 リポジトリテスト
```python
# tests/repositories/test_whiteboard_repository.py
import pytest
from sqlalchemy.ext.asyncio import AsyncSession
from app.repositories.whiteboard import WhiteboardRepository
from app.models.whiteboard import Whiteboard
from app.models.user import User

class TestWhiteboardRepository:
    @pytest.fixture
    async def db_session(self):
        # テスト用のデータベースセッションを作成
        # pytest-postgresql プラグインを使用
        pass
    
    @pytest.fixture
    def repository(self, db_session):
        return WhiteboardRepository(db_session)
    
    @pytest.fixture
    async def test_user(self, db_session):
        user = User(
            id="user-id",
            email="test@example.com",
            hashed_password="hashed_password"
        )
        db_session.add(user)
        await db_session.commit()
        return user
    
    @pytest.mark.asyncio
    async def test_create_whiteboard(self, repository, test_user):
        # Arrange
        whiteboard_data = {
            "title": "テストホワイトボード",
            "description": "テスト用の説明",
            "owner_id": test_user.id
        }
        
        # Act
        whiteboard = await repository.create(whiteboard_data)
        
        # Assert
        assert whiteboard.title == "テストホワイトボード"
        assert whiteboard.owner_id == test_user.id
        assert whiteboard.id is not None
    
    @pytest.mark.asyncio
    async def test_get_by_id(self, repository, test_user):
        # Arrange
        whiteboard = await repository.create({
            "title": "テストホワイトボード",
            "owner_id": test_user.id
        })
        
        # Act
        result = await repository.get_by_id(whiteboard.id)
        
        # Assert
        assert result.id == whiteboard.id
        assert result.title == "テストホワイトボード"
    
    @pytest.mark.asyncio
    async def test_get_by_owner_id(self, repository, test_user):
        # Arrange
        await repository.create({
            "title": "ホワイトボード1",
            "owner_id": test_user.id
        })
        await repository.create({
            "title": "ホワイトボード2",
            "owner_id": test_user.id
        })
        
        # Act
        whiteboards = await repository.get_by_owner_id(test_user.id)
        
        # Assert
        assert len(whiteboards) == 2
        assert all(wb.owner_id == test_user.id for wb in whiteboards)
```

### 3.3 WebSocketテスト

#### 3.3.1 WebSocket接続テスト
```python
# tests/websocket/test_whiteboard_websocket.py
import pytest
import json
from fastapi.testclient import TestClient
from app.main import app

class TestWhiteboardWebSocket:
    @pytest.fixture
    def client(self):
        return TestClient(app)
    
    def test_websocket_connection(self, client):
        # Act
        with client.websocket_connect("/ws/whiteboard/test-id") as websocket:
            # Assert
            assert websocket is not None
    
    def test_drawing_event_broadcast(self, client):
        # 複数のWebSocket接続をテスト
        with client.websocket_connect("/ws/whiteboard/test-id") as ws1:
            with client.websocket_connect("/ws/whiteboard/test-id") as ws2:
                # Act - 1つ目のクライアントから描画イベント送信
                drawing_event = {
                    "type": "drawing:start",
                    "data": {
                        "x": 100,
                        "y": 100,
                        "tool": "pen"
                    }
                }
                ws1.send_json(drawing_event)
                
                # Assert - 2つ目のクライアントが受信
                received = ws2.receive_json()
                assert received["type"] == "drawing:broadcast"
                assert received["data"]["x"] == 100
                assert received["data"]["y"] == 100
```

## 4. テスト環境設定

### 4.1 Vitest設定
```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import vue from '@vitejs/plugin-vue';
import { resolve } from 'path';

export default defineConfig({
  plugins: [vue()],
  test: {
    environment: 'jsdom',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'dist/',
        '**/*.d.ts',
        '**/*.test.ts',
        '**/*.spec.ts'
      ],
      thresholds: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80
        }
      }
    },
    setupFiles: ['./tests/setup.ts']
  },
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  }
});
```

### 4.2 pytest設定
```ini
# pytest.ini
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    --strict-markers
    --cov=app
    --cov-report=term-missing
    --cov-report=html
    --cov-report=xml
    --cov-fail-under=80
    --asyncio-mode=auto
markers =
    unit: Unit tests
    integration: Integration tests
    e2e: End-to-end tests
    slow: Slow running tests
```

### 4.3 Playwright設定
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    video: 'retain-on-failure',
    screenshot: 'only-on-failure'
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

## 5. CI/CDテスト自動化

### 5.1 GitHub Actions設定
```yaml
# .github/workflows/test.yml
name: Test Suite
on: [push, pull_request]

jobs:
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run unit tests
        run: npm run test:unit
        
      - name: Run integration tests
        run: npm run test:integration
        
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/coverage-final.json
          
  backend-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          
      - name: Run tests
        run: pytest
        env:
          DATABASE_URL: postgresql://postgres:test@localhost:5432/testdb
          
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        
      - name: Start services
        run: docker-compose up -d
        
      - name: Run E2E tests
        run: npx playwright test
        
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
```

## 6. テストデータ管理

### 6.1 フィクスチャ管理
```python
# tests/fixtures/whiteboard_fixtures.py
import pytest
from app.models.whiteboard import Whiteboard
from app.models.user import User

@pytest.fixture
def sample_user():
    return User(
        id="user-123",
        email="test@example.com",
        full_name="テストユーザー"
    )

@pytest.fixture
def sample_whiteboard(sample_user):
    return Whiteboard(
        id="whiteboard-123",
        title="テストホワイトボード",
        description="テスト用のホワイトボード",
        owner_id=sample_user.id
    )

@pytest.fixture
def sample_drawing_elements():
    return [
        {
            "id": "element-1",
            "type": "pen",
            "position": {"x": 100, "y": 100},
            "style": {"color": "#000000", "width": 2}
        },
        {
            "id": "element-2",
            "type": "rectangle",
            "position": {"x": 200, "y": 200, "width": 100, "height": 50},
            "style": {"color": "#FF0000", "fill": "#FFFF00"}
        }
    ]
```

### 6.2 モックデータ
```typescript
// tests/mocks/api.ts
import { rest } from 'msw';

export const handlers = [
  rest.get('/api/whiteboards', (req, res, ctx) => {
    return res(ctx.json([
      {
        id: 'whiteboard-1',
        title: 'テストホワイトボード1',
        created_at: '2024-07-06T00:00:00Z'
      },
      {
        id: 'whiteboard-2',
        title: 'テストホワイトボード2',
        created_at: '2024-07-06T01:00:00Z'
      }
    ]));
  }),
  
  rest.post('/api/whiteboards', (req, res, ctx) => {
    return res(ctx.json({
      id: 'new-whiteboard',
      title: 'New Whiteboard',
      created_at: new Date().toISOString()
    }));
  })
];
```

## 7. パフォーマンステスト

### 7.1 負荷テスト
```python
# tests/performance/test_load.py
import asyncio
import aiohttp
import time
from concurrent.futures import ThreadPoolExecutor

async def test_api_load():
    """API負荷テスト"""
    async with aiohttp.ClientSession() as session:
        tasks = []
        for i in range(100):
            task = session.get(f'http://localhost:8000/api/whiteboards/test-{i}')
            tasks.append(task)
        
        start_time = time.time()
        responses = await asyncio.gather(*tasks, return_exceptions=True)
        end_time = time.time()
        
        # 結果分析
        success_count = sum(1 for r in responses if hasattr(r, 'status') and r.status == 200)
        avg_response_time = (end_time - start_time) / len(responses)
        
        assert success_count >= 95  # 95%以上の成功率
        assert avg_response_time < 0.1  # 平均応答時間100ms以下
```

### 7.2 WebSocketパフォーマンステスト
```python
# tests/performance/test_websocket_load.py
import asyncio
import websockets
import json
import time

async def test_websocket_concurrent_connections():
    """WebSocket同時接続負荷テスト"""
    async def client_session(client_id):
        uri = f"ws://localhost:8000/ws/whiteboard/test-room"
        async with websockets.connect(uri) as websocket:
            # 描画イベント送信
            await websocket.send(json.dumps({
                "type": "drawing:start",
                "data": {"x": 100, "y": 100, "client_id": client_id}
            }))
            
            # 応答待機
            response = await websocket.recv()
            return json.loads(response)
    
    # 100個の同時接続をテスト
    start_time = time.time()
    tasks = [client_session(i) for i in range(100)]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    end_time = time.time()
    
    # 結果検証
    success_count = sum(1 for r in results if isinstance(r, dict))
    total_time = end_time - start_time
    
    assert success_count >= 95  # 95%以上の成功率
    assert total_time < 5.0     # 5秒以内完了
```

## 8. 品質管理

### 8.1 コードカバレッジ
```json
{
  "coverage": {
    "thresholds": {
      "global": {
        "branches": 80,
        "functions": 80,
        "lines": 80,
        "statements": 80
      },
      "each": {
        "branches": 70,
        "functions": 70,
        "lines": 70,
        "statements": 70
      }
    }
  }
}
```

### 8.2 テストレポート
```yaml
# .github/workflows/test-report.yml
name: Test Report
on:
  workflow_run:
    workflows: ["Test Suite"]
    types: [completed]

jobs:
  test-report:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Test Report
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: test-results.xml
          reporter: java-junit
```

---
**作成日**: 2024年7月6日  
**作成者**: [QAエンジニア名]  
**レビュー者**: [開発チームリーダー名]  
**承認者**: [技術リーダー名]  
**版数**: 1.0.0